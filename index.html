<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å®¢è¨‚ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: "Noto Sans TC", system-ui, -apple-system, sans-serif; 
      background-color: #f3f4f6;
      color: #1f2937;
      font-size: 15px;
    }
    
    /* === æ ¸å¿ƒï¼šæ‰‹æ©Ÿç‰ˆå¡ç‰‡å¼è¡¨æ ¼ (RWD Table) === */
    .responsive-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    
    @media (max-width: 768px) {
      .responsive-table thead { display: none; }
      
      .responsive-table tbody tr {
        display: block;
        margin-bottom: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        position: relative;
      }
      
      .responsive-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.4rem 0;
        border-bottom: 1px solid #f3f4f6;
        text-align: right;
        font-size: 0.95rem;
      }
      .responsive-table td:last-child { border-bottom: none; }
      
      .responsive-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #6b7280;
        font-size: 0.85rem;
        margin-right: 1rem;
        text-align: left;
        min-width: 80px; 
      }
      
      .responsive-table td.mobile-full-width {
        display: block;
        text-align: left;
      }
      .responsive-table td.mobile-full-width::before {
        display: block;
        margin-bottom: 0.25rem;
      }
    }

    @media (min-width: 769px) {
      .table-container {
        border-radius: 0.5rem;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .responsive-table th {
        background-color: #f8fafc;
        color: #475569;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        white-space: nowrap;
      }
      .responsive-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f5f9;
        white-space: nowrap;
        vertical-align: middle; 
      }
    }

    /* === å…ƒä»¶æ¨£å¼ === */
    .btn { 
      transition: all 0.2s; 
      display: inline-flex; align-items: center; justify-content: center; 
      font-weight: 500; border-radius: 0.5rem;
    }
    .btn:active { transform: scale(0.96); }

    .status-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 999px;
      font-size: 0.8rem; font-weight: 600;
      white-space: nowrap;
    }
    .status-badge.pending { background:#f3f4f6; color:#4b5563; }
    .status-badge.purchase { background:#e0e7ff; color:#4338ca; }
    .status-badge.arrived { background:#f3e8ff; color:#7e22ce; }
    .status-badge.missed { background:#ffedd5; color:#c2410c; }
    .status-badge.notified { background:#e0f2fe; color:#0369a1; }
    .status-badge.closed { background:#dcfce7; color:#15803d; }
    
    .tag { display:inline-flex; align-items:center; padding:0.1rem 0.5rem; margin:0.1rem; font-size:0.75rem; background:#fff; border:1px solid #d1d5db; color:#374151; border-radius:4px; }
    .tag .remove { margin-left:0.25rem; cursor:pointer; font-weight:bold; color:#ef4444; }
    .tag .remove:hover { color:#b91c1c; }

    .tab-scroll-container {
      display: flex; gap: 0.5rem; overflow-x: auto; 
      padding-bottom: 0.5rem; margin-bottom: 0.5rem;
      -webkit-overflow-scrolling: touch;
    }
    .tab-btn {
      padding: 0.4rem 0.8rem;
      border-radius: 99px;
      background: white;
      border: 1px solid #e5e7eb;
      color: #4b5563;
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .tab-btn.active {
      background: #4f46e5;
      color: white;
      border-color: #4f46e5;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }

    .modal-backdrop { 
      background-color: rgba(0,0,0,0.5); 
      backdrop-filter: blur(3px);
    }
    .modal-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      overflow: hidden;
      display: flex; flex-direction: column;
      max-height: 90vh;
    }

    .input-field {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow 0.2s;
      background-color: #fff;
    }
    .input-field:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    
    .input-field:disabled, .select-disabled {
      background-color: #f3f4f6;
      color: #9ca3af;
      cursor: not-allowed;
      opacity: 0.7;
      pointer-events: none;
    }
    
    .section-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .section-title::after {
      content: ""; flex: 1; height: 1px; background: #e5e7eb;
    }

    .loader {
      border: 3px solid #f3f3f3; border-top: 3px solid #6366f1;
      border-radius: 50%; width: 24px; height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .accordion-content {
      transition: grid-template-rows 0.3s ease-out;
      display: grid;
      grid-template-rows: 0fr;
    }
    .accordion-content.open {
      grid-template-rows: 1fr;
    }
    .accordion-inner { 
      overflow: hidden; 
      min-height: 0;
    }
    .accordion-toggle {
      width: 100%; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 1rem 1.25rem; 
      background-color: white; 
      transition: background-color 0.2s;
      border-left-width: 4px;
    }
    .accordion-toggle:hover { background-color: #f9fafb; }
    .accordion-toggle.border-indigo-500 { border-left-color: #6366f1; }
    .accordion-toggle.border-blue-500 { border-left-color: #3b82f6; }
    .accordion-toggle.border-red-500 { border-left-color: #ef4444; }
    .accordion-title {
      font-weight: 700;
      font-size: 1rem;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* æ²å‹•å®¹å™¨é«˜åº¦ */
    #dataTableContainer, #longTerm_dataTableContainer, #blacklist_dataTableContainer, #historyDataContainer {
      max-height: 750px;
      overflow: auto;
    }
  </style>
</head>
<body>

  <!-- é ‚éƒ¨å°èˆªåˆ— -->
  <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
    <div class="w-full max-w-[96%] mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="bg-indigo-600 text-white p-1.5 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
        </div>
        <h1 class="text-lg font-bold text-gray-800 tracking-tight">å®¢è¨‚ç³»çµ±</h1>
      </div>
      <div id="currentStoreBadge" class="hidden px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs font-medium"></div>
    </div>
  </nav>

  <!-- åŠ å¯¬ main å®¹å™¨ -->
  <main class="w-full max-w-[96%] mx-auto p-4 space-y-5 pb-20">

    <!-- 1. æ§åˆ¶å° -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
        <div class="flex items-center gap-4 w-full sm:w-auto">
          <!-- åº—åˆ¥é¸å–® -->
          <div class="relative flex-1 sm:flex-none sm:min-w-[180px]">
            <select id="storeSelect" class="input-field appearance-none pr-8 font-medium text-gray-700">
              <option value="">è«‹é¸æ“‡åº—åˆ¥</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
          </div>
          
          <!-- é–å®š & é€¾æœŸé€šçŸ¥é–‹é—œ -->
          <div class="flex items-center gap-4">
            <label class="flex items-center gap-1.5 cursor-pointer select-none">
                <input id="storeLockCheckbox" type="checkbox" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" />
                <span class="text-sm font-medium text-gray-600">é–å®š</span>
            </label>
            
            <label class="flex items-center gap-2 cursor-pointer select-none group" title="é–‹å•Ÿå¾Œï¼Œè‹¥è¨‚å–®é€¾æœŸ5å¤©æœªæ›´æ–°ï¼Œå°‡ç™¼é€LINEé€šçŸ¥">
                <div class="relative">
                  <input type="checkbox" id="notifyToggle" class="sr-only peer">
                  <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                </div>
                <span class="text-sm font-medium text-gray-600 group-hover:text-blue-600">é€¾æœŸé€šçŸ¥</span>
            </label>
          </div>
        </div>
        
        <!-- å‚™ä»½èˆ‡é‡æ•´ -->
        <div class="flex gap-2 w-full sm:w-auto">
          <button id="backupBtn" class="w-1/2 sm:w-auto btn bg-green-50 border border-green-200 text-green-700 hover:bg-green-100 px-3 py-2 text-sm">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
            å‚™ä»½è³‡æ–™
          </button>
          <button id="refreshStoresBtn" class="w-1/2 sm:w-auto btn bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 px-3 py-2 text-sm">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            é‡æ•´åˆ†åº—
          </button>
        </div>
      </div>
      <div id="top-message" class="mt-2 text-sm font-medium hidden"></div>
    </div>

    <!-- 2. æ–°å¢è¨‚å–® -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <button id="formToggleBtn" class="accordion-toggle border-indigo-500 border-b border-gray-100">
        <div class="accordion-title">
          <span class="text-indigo-600 text-xl">ğŸ“</span>
          <span>æ–°å¢å®¢è¨‚å–®</span>
        </div>
        <svg id="arrowIcon" class="w-5 h-5 text-gray-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
      </button>

      <div id="formContent" class="accordion-content">
        <div class="accordion-inner">
          <form id="orderForm" class="p-4 sm:p-6 space-y-6">
            <!-- é¡§å®¢å€å¡Š -->
            <div>
              <div class="section-title">é¡§å®¢è³‡æ–™</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div><label class="block text-xs font-medium text-gray-500 mb-1">å®¢è™Ÿ</label><input name="å®¢è™Ÿ" type="text" class="input-field" placeholder="è¼¸å…¥å®¢è™Ÿ" /></div>
                <div><label class="block text-xs font-medium text-gray-500 mb-1">å§“å</label><input name="å§“å" type="text" class="input-field" placeholder="é¡§å®¢å§“å" /></div>
                <div class="sm:col-span-2">
                  <label class="block text-xs font-medium text-gray-500 mb-1">é›»è©±</label>
                  <input id="phone" name="é€£çµ¡é›»è©±" type="tel" class="input-field" placeholder="09xx-xxx-xxx" />
                  <div id="phone-warning" class="hidden mt-1 text-xs text-red-600 font-bold bg-red-50 p-2 rounded flex items-center gap-1"><span>âš ï¸ æ­¤è™Ÿç¢¼åœ¨é»‘åå–®ä¸­ï¼</span></div>
                </div>
                <div class="sm:col-span-2 bg-green-50/50 p-3 rounded-lg border border-green-100">
                    <label class="block text-xs font-medium text-gray-500 mb-1">LINE è³‡è¨Š</label>
                    <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 cursor-pointer select-none border-r border-green-200 pr-3">
                           <input name="Lineé€šçŸ¥" type="checkbox" value="æ˜¯" class="w-4 h-4 text-green-600 rounded focus:ring-green-500" />
                           <span class="text-sm font-bold text-green-700">LINEé€šçŸ¥</span>
                        </label>
                        <input name="LINEåç¨±" type="text" class="input-field flex-1 text-sm" placeholder="è«‹è¼¸å…¥ LINE åç¨±" />
                    </div>
                </div>
              </div>
              <div class="flex gap-4 mt-3">
                 <label class="flex items-center gap-2 cursor-pointer"><input name="ä»˜æ¸…" type="checkbox" value="æ˜¯" class="w-4 h-4 text-indigo-600 rounded" /><span class="text-sm text-gray-700">å·²ä»˜æ¸…</span></label>
                 <label class="flex items-center gap-2 cursor-pointer"><input name="å›ºå®š/é•·æœŸå®¢è¨‚" type="checkbox" value="æ˜¯" class="w-4 h-4 text-indigo-600 rounded" /><span class="text-sm text-gray-700">é•·æœŸå®¢è¨‚</span></label>
              </div>
            </div>

            <!-- å•†å“å€å¡Š A -->
            <div class="bg-indigo-50/60 p-4 rounded-xl border border-indigo-100">
              <div class="section-title text-indigo-600 !border-indigo-200">å®¢è¨‚å•†å“ A (å¿…å¡«)</div>
              <div class="space-y-3">
                <input name="å®¢è¨‚å•†å“A" type="text" required class="input-field border-indigo-200 focus:border-indigo-500" placeholder="å•†å“åç¨±" />
                <div class="flex gap-3">
                  <input name="Aå•†å“è¦æ ¼" type="text" class="input-field flex-1 border-indigo-200" placeholder="è¦æ ¼/é‡é‡" />
                  <input name="Aæ•¸é‡" type="number" min="1" required class="input-field w-24 text-center border-indigo-200" placeholder="æ•¸é‡" />
                </div>
              </div>
            </div>

            <!-- å•†å“å€å¡Š B -->
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
              <div class="section-title">å®¢è¨‚å•†å“ B (é¸å¡«)</div>
              <div class="space-y-3">
                <input name="å®¢è¨‚å•†å“B" type="text" class="input-field bg-white" placeholder="å•†å“åç¨±" />
                <div class="flex gap-3">
                  <input name="Bå•†å“è¦æ ¼" type="text" class="input-field flex-1 bg-white" placeholder="è¦æ ¼/é‡é‡" />
                  <input name="Bæ•¸é‡" type="number" min="1" class="input-field w-24 text-center bg-white" placeholder="æ•¸é‡" />
                </div>
              </div>
            </div>

            <div class="pt-2"><label class="block text-xs font-medium text-gray-500 mb-1">å‚™è¨»</label><textarea name="å‚™è¨»" rows="2" class="input-field" placeholder="å…¶ä»–å‚™è¨»äº‹é …..."></textarea></div>
            <div class="pt-2">
              <button type="submit" id="submitButton" class="w-full btn bg-indigo-600 hover:bg-indigo-700 text-white py-3 text-lg shadow-lg shadow-indigo-200">é€å‡ºè¨‚å–®</button>
              <div id="message-box" class="hidden mt-3 p-3 rounded-lg text-center text-sm font-medium"></div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 3. è¨‚å–®ç®¡ç† -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <div class="space-y-3 mb-4">
        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><span>ğŸ“‹</span> è¨‚å–®ç®¡ç†</h2>
        <div class="flex gap-2 flex-wrap sm:flex-nowrap">
          <div class="relative flex-1 w-full">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></span>
            <input id="searchInput" type="text" class="input-field pl-10" placeholder="æœå°‹å§“åã€é›»è©±ã€å®¢è™Ÿ..." />
          </div>
          <button id="searchButton" class="btn bg-gray-800 text-white px-4 hover:bg-gray-900 shrink-0">æœå°‹</button>
          <!-- æŸ¥è©¢æ­·å²å®¢è¨‚æŒ‰éˆ• -->
          <button id="searchHistoryBtn" class="btn bg-blue-600 text-white px-4 hover:bg-blue-700 shrink-0 shadow-sm border border-blue-700">
             <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
             æŸ¥è©¢æ­·å²
          </button>
        </div>
        <div class="flex justify-between items-center pt-1">
           <div class="tab-scroll-container flex-1" id="statusTabs"></div>
           <div class="flex gap-2 ml-2 shrink-0">
             <button id="refreshButton" class="btn bg-white border border-gray-200 text-gray-600 p-2 rounded-full shadow-sm hover:bg-gray-50" title="é‡æ–°æ•´ç†">â†º</button>
             <button id="clearOverdueBtn" class="btn bg-white border border-orange-200 text-orange-600 px-3 py-1 text-xs hover:bg-orange-50">æ¸…é™¤é€¾æœŸ</button>
           </div>
        </div>
      </div>

      <div id="dataContainer" class="relative">
        <div id="dataLoader" class="hidden absolute inset-0 z-10 flex items-center justify-center bg-white/80 backdrop-blur-sm"><div class="loader"></div></div>
        <div id="data-message-box" class="hidden p-3 mb-3 bg-blue-50 text-blue-700 rounded-lg text-sm text-center"></div>
        <p id="noDataText" class="hidden text-center py-10 text-gray-400">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„è¨‚å–®</p>
        <div id="dataTableContainer" class="table-container hidden">
          <table class="responsive-table">
            <thead><tr id="data-table-headers"></tr></thead>
            <tbody id="data-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 4. é•·æœŸå®¢è¨‚ (Accordion) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <button id="longTermToggleBtn" class="accordion-toggle border-blue-500 border-b border-gray-100">
        <div class="accordion-title">
          <span class="text-blue-600 text-xl">ğŸ“…</span>
          <span>é•·æœŸå®¢è¨‚ç®¡ç†</span>
        </div>
        <svg id="longTermArrowIcon" class="w-5 h-5 text-gray-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
      </button>

      <div id="longTermContent" class="accordion-content">
        <div class="accordion-inner">
          <div class="p-4">
            <div class="flex gap-2 mb-3">
              <div class="relative flex-1"><input id="longTerm_searchInput" type="text" class="input-field" placeholder="æœå°‹é•·æœŸå®¢è¨‚..." /></div>
              <button id="longTerm_searchButton" class="btn bg-blue-600 text-white px-4">æœå°‹</button>
              <button id="longTerm_refreshButton" class="btn bg-white border border-gray-200 text-gray-600">â†º</button>
            </div>
            <div id="longTerm_dataContainer" class="relative min-h-[100px]">
              <div id="longTerm_dataLoader" class="hidden absolute inset-0 z-10 flex items-center justify-center bg-white/80"><div class="loader"></div></div>
              <p id="longTerm_noDataText" class="hidden text-center py-4 text-gray-400">ç„¡é•·æœŸè¨‚å–®</p>
              <div id="longTerm_dataTableContainer" class="table-container hidden">
                <table class="responsive-table">
                  <thead><tr id="longTerm_data-table-headers"></tr></thead>
                  <tbody id="longTerm_data-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 5. é»‘åå–® (Accordion) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <button id="blacklistToggleBtn" class="accordion-toggle border-red-500 border-b border-gray-100">
        <div class="accordion-title">
          <span class="text-red-600 text-xl">ğŸš«</span>
          <span>é»‘åå–®ç®¡ç†</span>
        </div>
        <svg id="blacklistArrowIcon" class="w-5 h-5 text-gray-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
      </button>

      <div id="blacklistContent" class="accordion-content">
        <div class="accordion-inner">
          <div class="p-4">
            <div class="flex gap-2 mb-3">
              <div class="relative flex-1"><input id="blacklist_searchInput" type="text" class="input-field" placeholder="æœå°‹é»‘åå–®..." /></div>
              <button id="blacklist_searchButton" class="btn bg-gray-600 text-white px-4">æœå°‹</button>
              <button id="blacklist_addButton" class="btn bg-red-600 text-white px-4">æ–°å¢</button>
            </div>
            <div id="blacklist_dataContainer" class="relative min-h-[100px]">
              <div id="blacklist_dataLoader" class="hidden absolute inset-0 z-10 flex items-center justify-center bg-white/80"><div class="loader"></div></div>
              <p id="blacklist_noDataText" class="hidden text-center py-4 text-gray-400">ç„¡é»‘åå–®è³‡æ–™</p>
              <div id="blacklist_dataTableContainer" class="table-container hidden">
                <table class="responsive-table">
                  <thead id="blacklist_data-table-headers">
                      <!-- é€™è£¡ç›´æ¥å¯«æ­»è¡¨é ­ï¼Œç¢ºä¿çµæ§‹å®Œæ•´ -->
                      <tr>
                        <th class="sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap">ç‹€æ…‹</th>
                        <th class="sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap">æ“ä½œ</th>
                        <th class="sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap">å®¢è™Ÿ</th>
                        <th class="sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap">å§“å</th>
                        <th class="sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap">é›»è©±</th>
                        <th class="sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap">åº—åˆ¥</th>
                        <th class="sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap">åŸå› </th>
                        <th class="sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap">æ—¥æœŸ</th>
                      </tr>
                  </thead>
                  <tbody id="blacklist_data-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <div id="blacklist-alert-bar" class="fixed bottom-0 inset-x-0 bg-red-600 text-white p-3 text-center font-bold shadow-lg z-50 hidden transform transition-transform translate-y-full"></div>

  <!-- History Search Modal (New) -->
  <div id="historyModalBackdrop" class="modal-backdrop hidden fixed inset-0 z-[60]">
    <div class="modal-card w-full max-w-4xl m-4 max-h-[90vh]">
      <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-blue-50">
        <h3 class="font-bold text-blue-800 text-lg">ğŸ“œ æ­·å²å®¢è¨‚è³‡æ–™ (å”¯è®€)</h3>
        <button id="closeHistoryModal" class="text-gray-400 hover:text-gray-600 p-1">&times;</button>
      </div>
      <div class="p-4 bg-white flex flex-col h-full">
         <div class="flex gap-2 mb-3">
            <input id="historySearchInput" type="text" class="input-field" placeholder="æœå°‹æ­·å²è¨‚å–® (å§“åã€é›»è©±ã€å•†å“...)" />
            <button id="historySearchBtn" class="btn bg-blue-600 text-white px-4">æœå°‹</button>
         </div>
         <div id="historyDataContainer" class="flex-1 overflow-auto border border-gray-200 rounded-lg relative min-h-[300px]">
            <div id="historyLoader" class="hidden absolute inset-0 z-10 flex items-center justify-center bg-white/80"><div class="loader"></div></div>
            <p id="historyNoData" class="hidden text-center py-10 text-gray-400">è«‹è¼¸å…¥é—œéµå­—é€²è¡Œæœå°‹</p>
            <table class="responsive-table">
               <thead><tr id="history-table-headers"></tr></thead>
               <tbody id="history-table-body"></tbody>
            </table>
         </div>
      </div>
    </div>
  </div>

  <!-- Backup Modal -->
  <div id="backupModalBackdrop" class="modal-backdrop hidden fixed inset-0 z-[70]">
    <div class="modal-card w-full max-w-sm m-4">
      <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-green-50">
        <h3 class="font-bold text-green-800 text-lg">å‚™ä»½ç¢ºèª</h3>
        <button id="closeBackupModal" class="text-gray-400 hover:text-gray-600">&times;</button>
      </div>
      <div class="p-6">
        <div id="backupModalContent" class="text-gray-700 mb-6">
           <!-- Dynamic Content -->
        </div>
        <div class="flex justify-end gap-3">
           <button id="cancelBackupBtn" class="btn bg-gray-100 text-gray-600 px-4 py-2 hover:bg-gray-200">å–æ¶ˆ</button>
           <button id="confirmBackupBtn" class="btn bg-green-600 text-white px-4 py-2 shadow-md shadow-green-200 hover:bg-green-700">ç¢ºèªå‚™ä»½</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModalBackdrop" class="modal-backdrop hidden fixed inset-0 z-[60]">
    <div class="modal-card w-full max-w-lg m-4 max-h-[90vh]">
      <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
        <h3 class="font-bold text-gray-800 text-lg">ç·¨è¼¯è¨‚å–®</h3>
        <button id="closeEditModal" class="text-gray-400 hover:text-gray-600 p-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <div class="overflow-y-auto p-4 sm:p-6 bg-white">
        <form id="editForm" class="space-y-5">
          <input type="hidden" id="editRowIndex" name="row" />
          <div class="grid grid-cols-2 gap-3">
             <div class="col-span-1"><label class="text-xs text-gray-500">å®¢è™Ÿ</label><input id="editCustomerID" name="å®¢è™Ÿ" class="input-field mt-1" /></div>
             <div class="col-span-1"><label class="text-xs text-gray-500">å§“å</label><input id="editCustomerName" name="å§“å" class="input-field mt-1" /></div>
             <div class="col-span-2"><label class="text-xs text-gray-500">é›»è©±</label><input id="editPhone" name="é€£çµ¡é›»è©±" class="input-field mt-1" /></div>
             
             <div class="col-span-2 bg-green-50 p-3 rounded-lg border border-green-100 flex items-center gap-3">
                <label class="flex items-center gap-2 cursor-pointer select-none border-r border-green-200 pr-3">
                   <input id="editLineNotify" name="Lineé€šçŸ¥" type="checkbox" value="æ˜¯" class="w-4 h-4 text-green-600 rounded focus:ring-green-500" />
                   <span class="text-sm font-bold text-green-700">LINEé€šçŸ¥</span>
                </label>
                <input id="editLineName" name="LINEåç¨±" type="text" class="input-field flex-1 text-sm h-8" placeholder="LINE åç¨±" />
             </div>
             
             <div class="col-span-2 bg-gray-50 p-3 rounded-lg border border-gray-100">
               <div class="flex gap-2 mb-2"><input id="editProductAName" name="å®¢è¨‚å•†å“A" class="input-field flex-[3]" placeholder="å•†å“ A" /><input id="editProductAQty" name="Aæ•¸é‡" type="number" class="input-field flex-[1] text-center" placeholder="æ•¸" /></div>
               <input id="editProductASpec" name="Aå•†å“è¦æ ¼" class="input-field text-sm" placeholder="è¦æ ¼ A" />
             </div>
             <div class="col-span-2 bg-gray-50 p-3 rounded-lg border border-gray-100">
               <div class="flex gap-2 mb-2"><input id="editProductBName" name="å®¢è¨‚å•†å“B" class="input-field flex-[3]" placeholder="å•†å“ B" /><input id="editProductBQty" name="Bæ•¸é‡" type="number" class="input-field flex-[1] text-center" placeholder="æ•¸" /></div>
               <input id="editProductBSpec" name="Bå•†å“è¦æ ¼" class="input-field text-sm" placeholder="è¦æ ¼ B" />
             </div>

             <div class="col-span-2 space-y-2 pt-2">
               <div class="flex items-center gap-2"><span class="text-xs text-gray-500 w-14">æ¡è³¼</span><input id="editPurchaseDate" name="æ¡è³¼æ—¥æœŸ" type="date" class="input-field flex-1 py-1 text-sm" /><button type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2 py-1" data-target="editPurchaseDate">ä»Š</button></div>
               
               <div class="flex items-center gap-2"><span class="text-xs text-gray-500 w-14">åˆ°è²¨</span><input id="editArrivalDate" name="åˆ°è²¨æ—¥æœŸ" type="date" class="input-field flex-1 py-1 text-sm" /><button type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2 py-1" data-target="editArrivalDate">ä»Š</button></div>
               
               <div class="bg-red-50 p-2 rounded border border-red-100">
                   <div class="flex items-center gap-2 mb-1">
                       <span class="text-xs font-bold text-red-500 w-14">æœªæ¥</span>
                       <input id="editMissedInput" type="date" class="input-field flex-1 py-1 text-sm" />
                       <button type="button" id="editAddMissed" class="btn bg-white border border-gray-200 text-gray-600 text-xs px-2 py-1">+</button>
                       <button type="button" id="editStampMissed" class="btn bg-red-100 text-red-600 text-xs px-2 py-1">ä»Š</button>
                   </div>
                   <div id="editMissedTags" class="flex flex-wrap gap-1"></div>
               </div>

               <div class="bg-blue-50 p-2 rounded border border-blue-100">
                   <div class="flex items-center gap-2 mb-1">
                       <span class="text-xs font-bold text-blue-500 w-14">é€šçŸ¥</span>
                       <input id="editNotifyInput" type="date" class="input-field flex-1 py-1 text-sm" />
                       <button type="button" id="editAddNotify" class="btn bg-white border border-gray-200 text-gray-600 text-xs px-2 py-1">+</button>
                       <button type="button" id="editStampNotify" class="btn bg-blue-100 text-blue-600 text-xs px-2 py-1">ä»Š</button>
                   </div>
                   <div id="editNotifyTags" class="flex flex-wrap gap-1"></div>
               </div>

               <div class="flex items-center gap-2"><span class="text-xs text-gray-500 w-14">å–èµ°</span><input id="editPickupDate" name="å–èµ°æ—¥æœŸ" type="date" class="input-field flex-1 py-1 text-sm" /><button type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2 py-1" data-target="editPickupDate">ä»Š</button></div>
             </div>

             <div class="col-span-2 py-2"><label class="flex items-center gap-2 select-none"><input id="editPaid" name="ä»˜æ¸…" type="checkbox" value="æ˜¯" class="w-4 h-4 text-indigo-600 rounded" /><span class="text-sm font-medium">å·²ä»˜æ¸…</span></label></div>
             <div class="col-span-2"><label class="text-xs text-gray-500">å‚™è¨»</label><textarea id="editNotes" name="å‚™è¨»" rows="2" class="input-field mt-1"></textarea></div>
             <input type="hidden" id="editStoreTransfer" name="åˆ†åº—èª¿æ’¥" /><input type="hidden" id="editMissedHidden" name="æœªæ¥é›»è©±æ—¥æœŸ" /><input type="hidden" id="editNotifyHidden" name="é€šçŸ¥æ—¥æœŸ" />
          </div>
          <div class="pt-4 border-t border-gray-100 flex gap-3">
             <button type="button" id="deleteEdit" class="btn flex-1 bg-red-50 text-red-600 py-2.5 hover:bg-red-100">åˆªé™¤</button>
             <button type="submit" id="saveEdit" class="btn flex-[2] bg-indigo-600 text-white py-2.5 shadow-md shadow-indigo-200 hover:bg-indigo-700">å„²å­˜è®Šæ›´</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Long Term Edit Modal -->
  <div id="longTerm_editModalBackdrop" class="modal-backdrop hidden fixed inset-0 z-[60]">
    <div class="modal-card w-full max-w-lg m-4 max-h-[90vh]">
      <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-blue-50">
        <h3 class="font-bold text-blue-800 text-lg">é•·æœŸå®¢è¨‚ç·¨è¼¯</h3>
        <button id="longTerm_closeEditModal" class="text-gray-400 hover:text-gray-600">&times;</button>
      </div>
      <div class="overflow-y-auto p-4">
        <form id="longTerm_editForm" class="space-y-4">
          <input type="hidden" id="longTerm_editRowIndex" name="row" />
          <div class="grid grid-cols-2 gap-3">
             <input id="longTerm_editCustomerID" name="å®¢è™Ÿ" class="input-field" placeholder="å®¢è™Ÿ" />
             <input id="longTerm_editCustomerName" name="å§“å" class="input-field" placeholder="å§“å" />
             <input id="longTerm_editPhone" name="é€£çµ¡é›»è©±" class="input-field col-span-2" placeholder="é›»è©±" />
             
             <div class="col-span-2 bg-gray-50 p-2 rounded border">
                <input id="longTerm_editProductAName" name="å®¢è¨‚å•†å“A" class="input-field mb-2" placeholder="å•†å“A" />
                <div class="flex gap-2"><input id="longTerm_editProductASpec" name="Aå•†å“è¦æ ¼" class="input-field flex-1" placeholder="è¦æ ¼" /><input id="longTerm_editProductAQty" name="Aæ•¸é‡" class="input-field w-20 text-center" placeholder="æ•¸" /></div>
             </div>
             
             <div class="col-span-2 space-y-2 pt-2">
               <div class="bg-gray-50 p-2 rounded border">
                 <div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold text-blue-600 w-14">æ¡è³¼</span><input id="longTerm_editPurchaseInput" type="date" class="input-field flex-1 py-1 text-sm"/><button type="button" id="longTerm_editAddPurchase" class="btn bg-white border text-xs px-2">+</button><button type="button" id="longTerm_editStampPurchase" class="btn bg-blue-100 text-blue-600 text-xs px-2">ä»Š</button></div>
                 <div id="longTerm_editPurchaseTags" class="flex flex-wrap gap-1"></div>
               </div>
               <div class="bg-gray-50 p-2 rounded border">
                 <div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold text-purple-600 w-14">åˆ°è²¨</span><input id="longTerm_editArrivalInput" type="date" class="input-field flex-1 py-1 text-sm"/><button type="button" id="longTerm_editAddArrival" class="btn bg-white border text-xs px-2">+</button><button type="button" id="longTerm_editStampArrival" class="btn bg-purple-100 text-purple-600 text-xs px-2">ä»Š</button></div>
                 <div id="longTerm_editArrivalTags" class="flex flex-wrap gap-1"></div>
               </div>
               <div class="bg-red-50 p-2 rounded border border-red-100">
                 <div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold text-red-500 w-14">æœªæ¥</span><input id="longTerm_editMissedInput" type="date" class="input-field flex-1 py-1 text-sm"/><button type="button" id="longTerm_editAddMissed" class="btn bg-white border text-xs px-2">+</button><button type="button" id="longTerm_editStampMissed" class="btn bg-red-100 text-red-600 text-xs px-2">ä»Š</button></div>
                 <div id="longTerm_editMissedTags" class="flex flex-wrap gap-1"></div>
               </div>
               <div class="bg-blue-50 p-2 rounded border border-blue-100">
                 <div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold text-blue-500 w-14">é€šçŸ¥</span><input id="longTerm_editNotifyInput" type="date" class="input-field flex-1 py-1 text-sm"/><button type="button" id="longTerm_editAddNotify" class="btn bg-white border text-xs px-2">+</button><button type="button" id="longTerm_editStampNotify" class="btn bg-blue-100 text-blue-600 text-xs px-2">ä»Š</button></div>
                 <div id="longTerm_editNotifyTags" class="flex flex-wrap gap-1"></div>
               </div>
               <div class="bg-gray-50 p-2 rounded border">
                 <div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold text-green-600 w-14">å–èµ°</span><input id="longTerm_editPickupInput" type="date" class="input-field flex-1 py-1 text-sm"/><button type="button" id="longTerm_editAddPickup" class="btn bg-white border text-xs px-2">+</button><button type="button" id="longTerm_editStampPickup" class="btn bg-green-100 text-green-600 text-xs px-2">ä»Š</button></div>
                 <div id="longTerm_editPickupTags" class="flex flex-wrap gap-1"></div>
               </div>
             </div>

             <div class="col-span-2"><textarea id="longTerm_editNotes" name="å‚™è¨»" class="input-field" placeholder="å‚™è¨»"></textarea></div>
          </div>
          <div class="flex gap-3 pt-3">
            <button type="button" id="longTerm_deleteEdit" class="btn bg-red-50 text-red-600 flex-1 py-2">åˆªé™¤</button>
            <button type="submit" id="longTerm_saveEdit" class="btn bg-blue-600 text-white flex-[2] py-2">å„²å­˜</button>
          </div>
          <input type="hidden" id="longTerm_editProductBName" name="å®¢è¨‚å•†å“B" /><input type="hidden" id="longTerm_editProductBSpec" name="Bå•†å“è¦æ ¼" /><input type="hidden" id="longTerm_editProductBQty" name="Bæ•¸é‡" /><input type="checkbox" id="longTerm_editPaid" name="ä»˜æ¸…" class="hidden" /><input type="hidden" id="longTerm_editPurchaseHidden" name="æ¡è³¼æ—¥æœŸ" /><input type="hidden" id="longTerm_editArrivalHidden" name="åˆ°è²¨æ—¥æœŸ" /><input type="hidden" id="longTerm_editPickupHidden" name="å–èµ°æ—¥æœŸ" /><input type="hidden" id="longTerm_editMissedHidden" name="æœªæ¥é›»è©±æ—¥æœŸ" /><input type="hidden" id="longTerm_editNotifyHidden" name="é€šçŸ¥æ—¥æœŸ" /><input type="hidden" id="longTerm_editStoreTransfer" name="åˆ†åº—èª¿æ’¥" />
        </form>
      </div>
    </div>
  </div>

  <!-- Blacklist Add Modal -->
  <div id="blacklist_addModalBackdrop" class="modal-backdrop hidden fixed inset-0 z-[60]">
    <div class="modal-card w-full max-w-sm m-4">
      <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-red-50">
        <h3 class="font-bold text-red-800 text-lg">æ–°å¢é»‘åå–®</h3>
        <button id="blacklist_closeAddModal" class="text-gray-400 hover:text-gray-600">&times;</button>
      </div>
      <div class="p-4">
        <form id="blacklist_addForm" class="space-y-3">
           <input name="é›»è©±" class="input-field" placeholder="é›»è©± (é¸å¡«)" />
           <input name="å§“å" class="input-field" placeholder="å§“å (é¸å¡«)" />
           <input name="å®¢è™Ÿ" class="input-field" placeholder="å®¢è™Ÿ (é¸å¡«)" />
           <input name="åŸå› " class="input-field" placeholder="åŸå› " required />
           <input type="hidden" id="blacklist_addStore" name="åº—åˆ¥" />
           <div class="flex justify-end gap-2 pt-2">
             <button type="button" id="blacklist_cancelAdd" class="btn bg-gray-100 px-4 py-2">å–æ¶ˆ</button>
             <button type="submit" class="btn bg-red-600 text-white px-4 py-2">æ–°å¢</button>
           </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Blacklist Edit Modal -->
  <div id="blacklist_editModalBackdrop" class="modal-backdrop hidden fixed inset-0 z-[60]">
    <div class="modal-card w-full max-w-sm m-4">
      <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-red-50">
        <h3 class="font-bold text-red-800 text-lg">ç·¨è¼¯é»‘åå–®</h3>
        <button id="blacklist_closeEditModal" class="text-gray-400 hover:text-gray-600">&times;</button>
      </div>
      <div class="p-4">
        <form id="blacklist_editForm" class="space-y-3">
           <input type="hidden" id="blacklist_editRowIndex" name="row" />
           <input id="bl_edit_phone" name="é›»è©±" class="input-field" placeholder="é›»è©±" />
           <input id="bl_edit_name" name="å§“å" class="input-field" placeholder="å§“å" />
           <input id="bl_edit_custID" name="å®¢è™Ÿ" class="input-field" placeholder="å®¢è™Ÿ" />
           <input id="bl_edit_reason" name="åŸå› " class="input-field" placeholder="åŸå› " />
           <input id="bl_edit_date" name="æ—¥æœŸ" type="date" class="input-field" />
           <textarea id="bl_edit_notes" name="å‚™è¨»" class="input-field" placeholder="å‚™è¨»"></textarea>
           <input type="hidden" id="bl_edit_store" name="åº—åˆ¥" />
           <div class="flex justify-end gap-2 pt-2">
             <button type="button" id="blacklist_cancelEdit" class="btn bg-gray-100 px-4 py-2">å–æ¶ˆ</button>
             <button type="submit" class="btn bg-green-600 text-white px-4 py-2">å„²å­˜</button>
           </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfDwaVTkHD-HGtY-6MzxscARnxwML9j1Ejn4v5cvPCAlgIPNRNkuU07r_61OBEVAYK/exec";
    
    // Declare Element Collections (Defined BEFORE setupTagControls is called)
    const longTerm_editPurchaseCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddPurchase'),
      stampBtn: document.getElementById('longTerm_editStampPurchase'),
      inputEl: document.getElementById('longTerm_editPurchaseInput'),
      tagsContainer: document.getElementById('longTerm_editPurchaseTags'),
      hiddenInput: document.getElementById('longTerm_editPurchaseHidden')
    };
    const longTerm_editArrivalCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddArrival'),
      stampBtn: document.getElementById('longTerm_editStampArrival'),
      inputEl: document.getElementById('longTerm_editArrivalInput'),
      tagsContainer: document.getElementById('longTerm_editArrivalTags'),
      hiddenInput: document.getElementById('longTerm_editArrivalHidden')
    };
    const longTerm_editPickupCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddPickup'),
      stampBtn: document.getElementById('longTerm_editStampPickup'),
      inputEl: document.getElementById('longTerm_editPickupInput'),
      tagsContainer: document.getElementById('longTerm_editPickupTags'),
      hiddenInput: document.getElementById('longTerm_editPickupHidden')
    };
    const longTerm_editMissedCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddMissed'),
      stampBtn: document.getElementById('longTerm_editStampMissed'),
      inputEl: document.getElementById('longTerm_editMissedInput'),
      tagsContainer: document.getElementById('longTerm_editMissedTags'),
      hiddenInput: document.getElementById('longTerm_editMissedHidden')
    };
    const longTerm_editNotifyCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddNotify'),
      stampBtn: document.getElementById('longTerm_editStampNotify'),
      inputEl: document.getElementById('longTerm_editNotifyInput'),
      tagsContainer: document.getElementById('longTerm_editNotifyTags'),
      hiddenInput: document.getElementById('longTerm_editNotifyHidden')
    };

    // Tag Helpers (Moved to top to prevent ReferenceError)
    function setupTagControls(addBtn, stampBtn, inputEl, tagsContainer, hiddenInput){
      let items = [];
      addBtn && addBtn.addEventListener('click', ()=>{
        const v = inputEl.value;
        if(v && !items.includes(v)){ items.push(v); items.sort(); inputEl.value=''; render(); }
      });
      stampBtn && stampBtn.addEventListener('click', ()=>{
        const v = todayLocalForInput();
        if(!items.includes(v)){ items.push(v); items.sort(); render(); }
      });
      function render(){
        tagsContainer.innerHTML = '';
        items.forEach(d => {
           const div = document.createElement('div');
           div.className = 'tag';
           div.innerHTML = `<span>${d}</span><span class="remove" data-date="${d}">&times;</span>`;
           tagsContainer.appendChild(div);
        });
        hiddenInput.value = items.join(', ');
      }
      tagsContainer.addEventListener('click', (e)=>{
        const removeBtn = e.target.closest('.remove');
        if(removeBtn){
          const d = removeBtn.dataset.date;
          items = items.filter(x=>x!==d); render();
        }
      });
      return { setItems(arr){ items = (arr||[]).filter(Boolean); items.sort(); render(); }, getItems(){ return items.slice(); } };
    }

    // Accordion Logic
    function toggleAccordion(btn, content, icon) {
      btn.addEventListener('click', () => {
        const isOpen = content.classList.contains('open');
        content.classList.toggle('open');
        icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
      });
    }
    
    toggleAccordion(document.getElementById('formToggleBtn'), document.getElementById('formContent'), document.getElementById('arrowIcon'));
    toggleAccordion(document.getElementById('longTermToggleBtn'), document.getElementById('longTermContent'), document.getElementById('longTermArrowIcon'));
    toggleAccordion(document.getElementById('blacklistToggleBtn'), document.getElementById('blacklistContent'), document.getElementById('blacklistArrowIcon'));

    // DOM Elements & Refs
    const storeSelect = document.getElementById('storeSelect');
    const storeLockCheckbox = document.getElementById('storeLockCheckbox');
    const notifyToggle = document.getElementById('notifyToggle');
    const refreshStoresBtn = document.getElementById('refreshStoresBtn');
    const backupBtn = document.getElementById('backupBtn'); 
    
    // Backup Modal Elements
    const backupModalBackdrop = document.getElementById('backupModalBackdrop');
    const closeBackupModal = document.getElementById('closeBackupModal');
    const cancelBackupBtn = document.getElementById('cancelBackupBtn');
    const confirmBackupBtn = document.getElementById('confirmBackupBtn');
    const backupModalContent = document.getElementById('backupModalContent');

    const form = document.getElementById('orderForm');
    const submitButton = document.getElementById('submitButton');
    const currentStoreBadge = document.getElementById('currentStoreBadge');
    const topMessage = document.getElementById('top-message');

    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const refreshButton = document.getElementById('refreshButton');
    const clearOverdueBtn = document.getElementById('clearOverdueBtn');
    
    const longTerm_searchInput = document.getElementById('longTerm_searchInput');
    const longTerm_searchButton = document.getElementById('longTerm_searchButton');
    const longTerm_refreshButton = document.getElementById('longTerm_refreshButton');

    const blacklistSearchInput = document.getElementById('blacklist_searchInput');
    const blacklistSearchButton = document.getElementById('blacklist_searchButton');
    const blacklistAddButton = document.getElementById('blacklist_addButton');
    
    // History Modal Elements
    const searchHistoryBtn = document.getElementById('searchHistoryBtn');
    const historyModalBackdrop = document.getElementById('historyModalBackdrop');
    const closeHistoryModal = document.getElementById('closeHistoryModal');
    const historySearchInput = document.getElementById('historySearchInput');
    const historySearchBtn = document.getElementById('historySearchBtn');
    const historyLoader = document.getElementById('historyLoader');
    const historyNoData = document.getElementById('historyNoData');
    const historyTableBody = document.getElementById('history-table-body');
    const historyTableHeaders = document.getElementById('history-table-headers');
    
    // Data Variables
    let allOrders = [];
    let allLongTermOrders = [];
    let allBlacklistData = [];
    let allStoresCache = []; // æ–°å¢ï¼šç”¨æ–¼å¿«å–åº—åˆ¥è³‡æ–™ (ä»£ç¢¼ vs åç¨±)
    let currentFilter = 'all';
    let dataTableHeaders = document.getElementById('data-table-headers');
    let longTerm_dataTableHeaders = document.getElementById('longTerm_data-table-headers');
    let blacklistDataTableHeaders = document.getElementById('blacklist_data-table-headers');
    let blacklistDataTableBody = document.getElementById('blacklist_data-table-body');
    
    // Init Helpers
    const editMissedCtrl = setupTagControls(document.getElementById('editAddMissed'), document.getElementById('editStampMissed'), document.getElementById('editMissedInput'), document.getElementById('editMissedTags'), document.getElementById('editMissedHidden'));
    const editNotifyCtrl = setupTagControls(document.getElementById('editAddNotify'), document.getElementById('editStampNotify'), document.getElementById('editNotifyInput'), document.getElementById('editNotifyTags'), document.getElementById('editNotifyHidden'));

    const longTerm_editPurchaseCtrl = setupTagControls(longTerm_editPurchaseCtrl_el.addBtn, longTerm_editPurchaseCtrl_el.stampBtn, longTerm_editPurchaseCtrl_el.inputEl, longTerm_editPurchaseCtrl_el.tagsContainer, longTerm_editPurchaseCtrl_el.hiddenInput);
    const longTerm_editArrivalCtrl = setupTagControls(longTerm_editArrivalCtrl_el.addBtn, longTerm_editArrivalCtrl_el.stampBtn, longTerm_editArrivalCtrl_el.inputEl, longTerm_editArrivalCtrl_el.tagsContainer, longTerm_editArrivalCtrl_el.hiddenInput);
    const longTerm_editPickupCtrl = setupTagControls(longTerm_editPickupCtrl_el.addBtn, longTerm_editPickupCtrl_el.stampBtn, longTerm_editPickupCtrl_el.inputEl, longTerm_editPickupCtrl_el.tagsContainer, longTerm_editPickupCtrl_el.hiddenInput);
    const longTerm_editMissedCtrl = setupTagControls(longTerm_editMissedCtrl_el.addBtn, longTerm_editMissedCtrl_el.stampBtn, longTerm_editMissedCtrl_el.inputEl, longTerm_editMissedCtrl_el.tagsContainer, longTerm_editMissedCtrl_el.hiddenInput);
    const longTerm_editNotifyCtrl = setupTagControls(longTerm_editNotifyCtrl_el.addBtn, longTerm_editNotifyCtrl_el.stampBtn, longTerm_editNotifyCtrl_el.inputEl, longTerm_editNotifyCtrl_el.tagsContainer, longTerm_editNotifyCtrl_el.hiddenInput);

    // Init
    window.addEventListener('load', async () => {
      renderTabs();
      await fetchStores();
      await fetchOrders(); 
      fetchBlacklistData();
    });

    // Helper Functions
    function pad(n){ return String(n).padStart(2,'0'); }
    function todayLocalForInput() { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function digitsOnly(s){ return String(s||'').replace(/\D/g,''); }
    function parseMultiDateStringToArray(dateString) {
        if (!dateString || typeof dateString !== 'string') return [];
        return dateString.split(/[,;ï¼Œ\s]+/).map(s => toDateOnly(s)).filter(Boolean);
    }
    function toDateOnly(val) {
      if (!val && val !== 0) return '';
      const s = String(val).trim();
      const m1 = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
      if (m1) {
        return `${m1[1]}-${String(m1[2]).padStart(2,'0')}-${String(m1[3]).padStart(2,'0')}`;
      }
      return '';
    }
    
    function isChecked(value) {
        if (typeof value === 'boolean') return value;
        if (typeof value === 'string') {
            const s = value.toLowerCase().trim();
            return s === 'æ˜¯' || s === 'true' || s === '1' || s === 'yes';
        }
        return false;
    }
    
    function showTopMessage(txt, isError=false){
      if(!txt){ topMessage.classList.add('hidden'); topMessage.textContent=''; return; }
      topMessage.textContent = txt;
      topMessage.classList.remove('hidden');
      topMessage.style.color = isError ? '#b91c1c' : '#065f46';
    }
    
    function formatFieldValueIfDate(header, val) {
       // Simple passthrough or formatting if needed for blacklist
       if(!val) return '';
       if (header.includes('æ—¥æœŸ') || header.includes('Date')) {
           return formatDateShort(val);
       }
       return val;
    }
    
    function getSelectedStoreName() {
        const opt = storeSelect.options[storeSelect.selectedIndex];
        return opt ? (opt.dataset.name || opt.text) : '';
    }

    // Tabs
    function renderTabs() {
      const STATUS_TABS = [
        { key: 'all', label: 'å…¨éƒ¨' },
        { key: 'æœªè™•ç†', label: 'æœªè™•ç†' },
        { key: 'å·²æ¡è³¼', label: 'å·²æ¡è³¼' },
        { key: 'å·²åˆ°è²¨', label: 'å·²åˆ°è²¨' },
        { key: 'å·²é€šçŸ¥', label: 'å·²é€šçŸ¥' },
        { key: 'æœªæ¥', label: 'æœªæ¥' },
        { key: 'å·²å–è²¨', label: 'å·²å–è²¨' }
      ];
      const container = document.getElementById('statusTabs');
      container.innerHTML = STATUS_TABS.map(tab => `
        <button class="tab-btn ${tab.key === currentFilter ? 'active' : ''}" 
                onclick="setFilter('${tab.key}')">
          ${tab.label}
        </button>
      `).join('');
    }
    window.setFilter = (key) => { currentFilter = key; renderTabs(); renderTable(); };

    // Fetch Stores
    async function fetchStores() {
      try {
        const resp = await fetch(`${SCRIPT_URL}?action=stores`);
        const json = await resp.json();
        const stores = json.stores || [];
        
        allStoresCache = stores; // å„²å­˜åº—åˆ¥æ¸…å–®ä»¥ä¾›æŸ¥è©¢

        storeSelect.innerHTML = '<option value="">è«‹é¸æ“‡åº—åˆ¥</option>';
        stores.forEach(s => {
          if(s.name === 'åº—å' || s.code === 'åº—ç·¨è™Ÿ') return;
          const opt = document.createElement('option');
          opt.value = s.code; 
          opt.textContent = s.name ? `${s.name}` : s.code;
          // === ä¿®æ­£ï¼šåŠ å…¥ data-name å±¬æ€§ä»¥ç¢ºä¿èƒ½æŠ“åˆ°æ­£ç¢ºåº—å ===
          opt.dataset.name = s.name || s.code;
          storeSelect.appendChild(opt);
        });
        const saved = localStorage.getItem('selected_store');
        if(saved && Array.from(storeSelect.options).some(o=>o.value===saved)) {
          storeSelect.value = saved; updateStoreDisplay();
        }
        checkStoreSettings(); 
      } catch(e) { console.error(e); }
    }
    
    storeSelect.addEventListener('change', () => {
      localStorage.setItem('selected_store', storeSelect.value);
      updateStoreDisplay(); 
      checkStoreSettings();
      fetchOrders();
    });
    
    function updateStoreDisplay() {
      const text = storeSelect.options[storeSelect.selectedIndex]?.text;
      if(text && storeSelect.value) { currentStoreBadge.textContent = text; currentStoreBadge.classList.remove('hidden'); }
      else { currentStoreBadge.classList.add('hidden'); }
    }

    // Fetch Orders
    async function fetchOrders() {
      document.getElementById('dataLoader').classList.remove('hidden');
      document.getElementById('data-table-body').innerHTML = '';
      document.getElementById('noDataText').classList.add('hidden');
      document.getElementById('data-message-box').classList.add('hidden'); // Clear previous errors
      
      const store = storeSelect.value;
      const url = store ? `${SCRIPT_URL}?store=${encodeURIComponent(store)}` : SCRIPT_URL;
      try {
        const resp = await fetch(url);
        const json = await resp.json();
        const rows = json.rows || [];
        allOrders = []; allLongTermOrders = [];
        rows.forEach(r => {
           if(r['å›ºå®š/é•·æœŸå®¢è¨‚'] === 'æ˜¯' || r['å›ºå®š/é•·æœŸå®¢è¨‚'] === true) allLongTermOrders.push(r);
           else allOrders.push(r);
        });
        
        const fixedHeaders = ['å§“å', 'æ‰‹æ©Ÿè™Ÿç¢¼', 'å•†å“', 'é€²åº¦', 'ä»˜æ¸…', 'å»ºç«‹æ—¥æœŸ', 'æœ€å¾Œæ›´æ–°'];
        renderTableHeaders(fixedHeaders);
        const longTermHeaders = ['å§“å', 'æ‰‹æ©Ÿè™Ÿç¢¼', 'å•†å“', 'é€²åº¦', 'ä»˜æ¸…', 'å»ºç«‹æ—¥æœŸ', 'æœ€å¾Œæ›´æ–°'];
        renderLongTermTableHeaders(longTermHeaders);

        renderTable(); 
        renderLongTermTable();
      } catch(e) { 
        console.error(e); 
        document.getElementById('data-message-box').classList.remove('hidden');
        document.getElementById('data-message-box').textContent = 'è®€å–å¤±æ•—ï¼š' + e.message;
      } finally { document.getElementById('dataLoader').classList.add('hidden'); }
    }

    function renderTableHeaders(displayHeaders){
      if(!dataTableHeaders) return;
      dataTableHeaders.innerHTML = '';
      const headers = ['ç‹€æ…‹','åˆªé™¤', ...displayHeaders];
      headers.forEach(h=>{
        const th = document.createElement('th');
        th.className = 'sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap'; 
        th.textContent = h;
        dataTableHeaders.appendChild(th);
      });
    }

    function renderLongTermTableHeaders(displayHeaders){
      if(!longTerm_dataTableHeaders) return;
      longTerm_dataTableHeaders.innerHTML = '';
      const headers = ['ç‹€æ…‹','åˆªé™¤', ...displayHeaders];
      headers.forEach(h=>{
        const th = document.createElement('th');
        th.className = 'sticky top-0 z-30 bg-gray-100 text-gray-900 font-bold px-4 py-3 border-b-2 border-gray-200 whitespace-nowrap';
        th.textContent = h;
        longTerm_dataTableHeaders.appendChild(th);
      });
    }

    // Render Table
    function renderTable() {
      const tbody = document.getElementById('data-table-body');
      const noData = document.getElementById('noDataText');
      const tableContainer = document.getElementById('dataTableContainer');
      tbody.innerHTML = '';
      const term = document.getElementById('searchInput').value.trim().toLowerCase();
      let filtered = allOrders.filter(o => {
        const status = getStatus(o);
        if (currentFilter !== 'all' && status.key !== currentFilter) return false;
        if (!term) return true;
        return Object.values(o).some(val => String(val).toLowerCase().includes(term));
      });
      filtered.sort((a,b) => {
         const ta = new Date(a['æœ€å¾Œæ›´æ–°æ™‚é–“'] || a['å»ºç«‹æ—¥æœŸ'] || 0).getTime();
         const tb = new Date(b['æœ€å¾Œæ›´æ–°æ™‚é–“'] || b['å»ºç«‹æ—¥æœŸ'] || 0).getTime();
         return tb - ta;
      });
      
      if(filtered.length === 0) { 
        noData.classList.remove('hidden'); 
        tableContainer.classList.add('hidden'); // Hide table when empty
        return; 
      }
      else { 
        noData.classList.add('hidden'); 
        tableContainer.classList.remove('hidden'); // Show table when has data
      }

      filtered.forEach(order => {
        const tr = document.createElement('tr');
        
        // --- æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–· Lineé€šçŸ¥ æ±ºå®šèƒŒæ™¯è‰² ---
        const isLineNotify = isChecked(order['Lineé€šçŸ¥']);
        
        if (isLineNotify) {
            // æ‰“å‹¾ï¼šæ·ºç¶ è‰²ï¼Œä¸¦åŠ ä¸Š hover æ•ˆæœ
            tr.className = 'bg-green-100 hover:bg-green-200 cursor-pointer transition-colors border-l-4 border-green-400';
        } else {
            // æ²’æ‰“å‹¾ï¼šç¶­æŒåŸæœ¬çš„æ–‘é¦¬ç´‹ (ä¸€è¡Œç™½ã€ä¸€è¡Œç°)
            tr.className = 'bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer transition-colors';
        }

        tr.onclick = (e) => { if(e.target.closest('button')) return; openEditModal(order); };
        const status = getStatus(order);
        
        const productA = order['å®¢è¨‚å•†å“A'] ? `[${order['å®¢è¨‚å•†å“A']}]${order['Aå•†å“è¦æ ¼'] ? `(${order['Aå•†å“è¦æ ¼']})` : ''} ${order['Aæ•¸é‡'] ? 'x' + order['Aæ•¸é‡'] : ''}` : '';
        const productB = order['å®¢è¨‚å•†å“B'] ? `[${order['å®¢è¨‚å•†å“B']}]${order['Bå•†å“è¦æ ¼'] ? `(${order['Bå•†å“è¦æ ¼']})` : ''} ${order['Bæ•¸é‡'] ? 'x' + order['Bæ•¸é‡'] : ''}` : '';
        
        const formatMulti = (val) => {
            if(!val) return '';
            const parts = String(val).split(/[,;ï¼Œ\s]+/).filter(Boolean);
            if(parts.length === 0) return '';
            return parts.map(d => {
                const dobj = new Date(d);
                if(isNaN(dobj.getTime())) return d;
                return `${pad(dobj.getMonth()+1)}/${pad(dobj.getDate())}`;
            }).join(', ');
        };

        const formatDateMMDD = (val) => {
            if(!val) return '';
            const d = new Date(val);
            if(isNaN(d.getTime())) return String(val).substring(0, 10);
            return `${pad(d.getMonth()+1)}/${pad(d.getDate())}`;
        }

        let dateDisplay = '';
        if(order['æ¡è³¼æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-blue-600">æ¡è³¼: ${formatDateMMDD(order['æ¡è³¼æ—¥æœŸ'])}</div>`;
        if(order['åˆ°è²¨æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-purple-600">åˆ°è²¨: ${formatDateMMDD(order['åˆ°è²¨æ—¥æœŸ'])}</div>`;
        
        if(order['æœªæ¥é›»è©±æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-red-500">æœªæ¥: ${formatMulti(order['æœªæ¥é›»è©±æ—¥æœŸ'])}</div>`;
        if(order['é€šçŸ¥æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-orange-600">é€šçŸ¥: ${formatMulti(order['é€šçŸ¥æ—¥æœŸ'])}</div>`;
        
        if(order['å–èµ°æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-green-600">å–èµ°: ${formatDateMMDD(order['å–èµ°æ—¥æœŸ'])}</div>`;
        if(!dateDisplay) dateDisplay = `<div class="text-xs text-gray-400">${formatDateMMDD(order['å»ºç«‹æ—¥æœŸ'])}</div>`;

        let phoneDisplay = order['é›»è©±'] || order['é€£çµ¡é›»è©±'] || '';
        if (phoneDisplay) {
             phoneDisplay = formatPhone(phoneDisplay);
        }

        const isPaid = isChecked(order['ä»˜æ¸…'] || order['paid']);
        const paidDisplay = isPaid ? '<span class="text-green-600 font-bold">æ˜¯</span>' : '<span class="text-gray-400">å¦</span>';

        const createdDate = formatDateMMDD(order['å»ºç«‹æ—¥æœŸ'] || order['creationDate'] || order['å»ºç«‹æ™‚é–“']);
        const updatedDate = formatDateMMDD(order['æœ€å¾Œæ›´æ–°æ™‚é–“']);

        tr.innerHTML = `
          <td><span class="status-badge ${status.class}">${status.label}</span></td>
          <td class="text-center"> <!-- FIXED: Center using text-center -->
             <button type="button" class="btn bg-red-100 text-red-600 px-2 py-1 text-xs" onclick="deleteRow(${order['__row']})">åˆªé™¤</button>
          </td>
          <td data-label="å§“å" class="font-medium text-gray-900">${order['å§“å'] || 'æœªçŸ¥'}</td>
          <td data-label="æ‰‹æ©Ÿè™Ÿç¢¼">${phoneDisplay}</td>
          <td data-label="å•†å“" class="mobile-full-width">
             <div class="font-medium text-indigo-900">${productA}</div>
             ${productB ? `<div class="font-medium text-indigo-900 mt-1">${productB}</div>` : ''}
          </td>
          <td data-label="é€²åº¦" class="text-gray-500">
             ${dateDisplay || '-'}
          </td>
          <td data-label="ä»˜æ¸…">${paidDisplay}</td>
          <td data-label="å»ºç«‹æ—¥æœŸ" class="text-xs text-gray-400">${createdDate}</td>
          <td data-label="æœ€å¾Œæ›´æ–°" class="text-xs text-gray-400">${updatedDate}</td>
        `;
        
        const delBtn = tr.querySelector('button[onclick^="deleteRow"]');
        if(delBtn) {
            delBtn.onclick = (e) => { e.stopPropagation(); if(confirm('åˆªé™¤?')) deleteRow(order['__row']); };
            delBtn.removeAttribute('onclick');
        }

        tbody.appendChild(tr);
      });
    }
    
    function renderLongTermTable() {
      const tbody = document.getElementById('longTerm_data-table-body');
      const noData = document.getElementById('longTerm_noDataText');
      const tableContainer = document.getElementById('longTerm_dataTableContainer');
      tbody.innerHTML = '';
      const term = document.getElementById('longTerm_searchInput').value.trim().toLowerCase();
      let filtered = allLongTermOrders.filter(o => {
        if (!term) return true;
        // Search Filter fix: search all values
        return Object.values(o).some(val => String(val).toLowerCase().includes(term));
      });
      
      if(filtered.length === 0) { 
        noData.classList.remove('hidden'); 
        tableContainer.classList.add('hidden'); // Hide table when empty
        return; 
      }
      else { 
        noData.classList.add('hidden'); 
        tableContainer.classList.remove('hidden'); // Show table when has data
      }
      
      filtered.forEach(order => {
        const tr = document.createElement('tr');
        tr.className = 'bg-white even:bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors';
        tr.onclick = (e) => { if(e.target.closest('button')) return; openLongTermEditModal(order); };
        const status = getStatus(order);
        
        const productA = order['å®¢è¨‚å•†å“A'] ? `[${order['å®¢è¨‚å•†å“A']}]${order['Aå•†å“è¦æ ¼'] ? `(${order['Aå•†å“è¦æ ¼']})` : ''} ${order['Aæ•¸é‡'] ? 'x' + order['Aæ•¸é‡'] : ''}` : '';
        const productB = order['å®¢è¨‚å•†å“B'] ? `[${order['å®¢è¨‚å•†å“B']}]${order['Bå•†å“è¦æ ¼'] ? `(${order['Bå•†å“è¦æ ¼']})` : ''} ${order['Bæ•¸é‡'] ? 'x' + order['Bæ•¸é‡'] : ''}` : '';

        const formatMulti = (val) => {
            if(!val) return '';
            const parts = String(val).split(/[,;ï¼Œ\s]+/).filter(Boolean);
            if(parts.length === 0) return '';
            return parts.map(d => {
                const dobj = new Date(d);
                if(isNaN(dobj.getTime())) return d;
                return `${pad(dobj.getMonth()+1)}/${pad(dobj.getDate())}`;
            }).join(', ');
        };

        const formatDateMMDD = (val) => {
            if(!val) return '';
            const d = new Date(val);
            if(isNaN(d.getTime())) return String(val).substring(0, 10);
            return `${pad(d.getMonth()+1)}/${pad(d.getDate())}`;
        }

        let dateDisplay = '';
        if(order['æ¡è³¼æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-blue-600">æ¡è³¼: ${formatMulti(order['æ¡è³¼æ—¥æœŸ'])}</div>`;
        if(order['åˆ°è²¨æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-purple-600">åˆ°è²¨: ${formatMulti(order['åˆ°è²¨æ—¥æœŸ'])}</div>`;
        
        if(order['æœªæ¥é›»è©±æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-red-500">æœªæ¥: ${formatMulti(order['æœªæ¥é›»è©±æ—¥æœŸ'])}</div>`;
        if(order['é€šçŸ¥æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-orange-600">é€šçŸ¥: ${formatMulti(order['é€šçŸ¥æ—¥æœŸ'])}</div>`;
        
        if(order['å–èµ°æ—¥æœŸ']) dateDisplay += `<div class="text-xs text-green-600">å–èµ°: ${formatMulti(order['å–èµ°æ—¥æœŸ'])}</div>`;
        
        let phoneDisplay = order['é›»è©±'] || order['é€£çµ¡é›»è©±'] || '';
        if (phoneDisplay) {
             phoneDisplay = formatPhone(phoneDisplay);
        }

        const isPaid = isChecked(order['ä»˜æ¸…'] || order['paid']);
        const paidDisplay = isPaid ? '<span class="text-green-600 font-bold">æ˜¯</span>' : '<span class="text-gray-400">å¦</span>';
        const createdDate = formatDateMMDD(order['å»ºç«‹æ—¥æœŸ'] || order['creationDate'] || order['å»ºç«‹æ™‚é–“']);
        const updatedDate = formatDateMMDD(order['æœ€å¾Œæ›´æ–°æ™‚é–“']);

        tr.innerHTML = `
          <td><span class="status-badge ${status.class}">${status.label}</span></td>
          <td class="text-center"> <!-- FIXED: Center using text-center -->
             <button type="button" class="btn bg-red-100 text-red-600 px-2 py-1 text-xs" onclick="deleteRow(${order['__row']})">åˆªé™¤</button>
          </td>
          <td data-label="å§“å" class="font-medium text-gray-900">${order['å§“å'] || 'æœªçŸ¥'}</td>
          <td data-label="æ‰‹æ©Ÿè™Ÿç¢¼">${phoneDisplay}</td>
          <td data-label="å•†å“" class="mobile-full-width">
             <div class="font-medium text-blue-900">${productA}</div>
             ${productB ? `<div class="font-medium text-blue-900 mt-1">${productB}</div>` : ''}
          </td>
          <td data-label="é€²åº¦" class="text-gray-500">${dateDisplay || '-'}</td>
          <td data-label="ä»˜æ¸…">${paidDisplay}</td>
          <td data-label="å»ºç«‹æ—¥æœŸ" class="text-xs text-gray-400">${createdDate}</td>
          <td data-label="æœ€å¾Œæ›´æ–°" class="text-xs text-gray-400">${updatedDate}</td>
        `;

        const delBtn = tr.querySelector('button[onclick^="deleteRow"]');
        if(delBtn) {
            delBtn.onclick = (e) => { e.stopPropagation(); if(confirm('åˆªé™¤?')) deleteRow(order['__row']); };
            delBtn.removeAttribute('onclick');
        }

        tbody.appendChild(tr);
      });
    }

    function getStatus(order) {
       if(order['å–èµ°æ—¥æœŸ']) return { key: 'å·²å–è²¨', label: 'å·²å–è²¨', class: 'closed' };
       if(order['é€šçŸ¥æ—¥æœŸ']) return { key: 'å·²é€šçŸ¥', label: 'å·²é€šçŸ¥', class: 'notified' };
       if(order['æœªæ¥é›»è©±æ—¥æœŸ']) return { key: 'æœªæ¥', label: 'æœªæ¥', class: 'missed' };
       if(order['åˆ°è²¨æ—¥æœŸ']) return { key: 'å·²åˆ°è²¨', label: 'å·²åˆ°è²¨', class: 'arrived' };
       if(order['æ¡è³¼æ—¥æœŸ']) return { key: 'å·²æ¡è³¼', label: 'å·²æ¡è³¼', class: 'purchase' };
       return { key: 'æœªè™•ç†', label: 'æœªè™•ç†', class: 'pending' };
    }
    function formatPhone(rawVal){
      if(rawVal===undefined || rawVal===null) return '';
      const s = String(rawVal).trim();
      if(s.startsWith('0')) return s;
      if(/^\d{9}$/.test(s)) return '0'+s;
      return s;
    }
    function formatDateShort(dateStr) {
      if(!dateStr) return '';
      const parts = String(dateStr).split(/[,;ï¼Œ\s]+/);
      const last = parts[parts.length-1]; 
      const d = new Date(last);
      if(isNaN(d.getTime())) return `${pad(d.getMonth()+1)}/${pad(d.getDate())}`; // Fallback if parse fails but logic was tried
      return `${pad(d.getMonth()+1)}/${pad(d.getDate())}`;
    }

    // Modal Helpers
    const editModal = document.getElementById('editModalBackdrop');
    const longTermEditModal = document.getElementById('longTerm_editModalBackdrop');
    const blacklistEditModal = document.getElementById('blacklist_editModalBackdrop');
    
    function setInputDate(id, val) {
       const el = document.getElementById(id);
       if(!val) { el.value = ''; return; }
       const parts = String(val).split(/[,;ï¼Œ\s]+/);
       const d = new Date(parts[parts.length-1]);
       if(!isNaN(d)) { el.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    }

    function openEditModal(order) {
       document.getElementById('editRowIndex').value = order['__row'];
       document.getElementById('editCustomerID').value = order['å®¢è™Ÿ']||'';
       document.getElementById('editCustomerName').value = order['å§“å']||'';
       document.getElementById('editPhone').value = order['é›»è©±']||order['é€£çµ¡é›»è©±']||'';
       document.getElementById('editProductAName').value = order['å®¢è¨‚å•†å“A']||'';
       document.getElementById('editProductASpec').value = order['Aå•†å“è¦æ ¼']||'';
       document.getElementById('editProductAQty').value = order['Aæ•¸é‡']||'';
       document.getElementById('editProductBName').value = order['å®¢è¨‚å•†å“B']||'';
       document.getElementById('editProductBSpec').value = order['Bå•†å“è¦æ ¼']||'';
       document.getElementById('editProductBQty').value = order['Bæ•¸é‡']||'';
       document.getElementById('editPaid').checked = (order['paid'] === 'æ˜¯' || order['paid'] === true || order['ä»˜æ¸…'] === 'æ˜¯');
       document.getElementById('editNotes').value = order['å‚™è¨»']||'';
       
       // Populate LINE info
       document.getElementById('editLineName').value = order['LINEåç¨±'] || '';
       document.getElementById('editLineNotify').checked = isChecked(order['Lineé€šçŸ¥']);
       
       setInputDate('editPurchaseDate', order['æ¡è³¼æ—¥æœŸ']);
       setInputDate('editArrivalDate', order['åˆ°è²¨æ—¥æœŸ']);
       setInputDate('editPickupDate', order['å–èµ°æ—¥æœŸ']);
       
       // Populate Tags for normal edit modal
       try {
         const missed = parseMultiDateStringToArray(order['æœªæ¥é›»è©±æ—¥æœŸ']);
         const notify = parseMultiDateStringToArray(order['é€šçŸ¥æ—¥æœŸ']);
         editMissedCtrl.setItems(missed);
         editNotifyCtrl.setItems(notify);
       } catch(e) { console.warn(e); }

       editModal.classList.remove('hidden');
    }
    
    function openLongTermEditModal(order) {
       document.getElementById('longTerm_editRowIndex').value = order['__row'];
       document.getElementById('longTerm_editCustomerID').value = order['å®¢è™Ÿ']||'';
       document.getElementById('longTerm_editCustomerName').value = order['å§“å']||'';
       document.getElementById('longTerm_editPhone').value = order['é›»è©±']||order['é€£çµ¡é›»è©±']||'';
       document.getElementById('longTerm_editProductAName').value = order['å®¢è¨‚å•†å“A']||'';
       document.getElementById('longTerm_editProductASpec').value = order['Aå•†å“è¦æ ¼']||'';
       document.getElementById('longTerm_editProductAQty').value = order['Aæ•¸é‡']||'';
       document.getElementById('longTerm_editProductBName').value = order['å®¢è¨‚å•†å“B']||'';
       document.getElementById('longTerm_editProductBSpec').value = order['Bå•†å“è¦æ ¼']||'';
       document.getElementById('longTerm_editProductBQty').value = order['Bæ•¸é‡']||'';
       document.getElementById('longTerm_editPaid').checked = (order['paid'] === 'æ˜¯' || order['paid'] === true || order['ä»˜æ¸…'] === 'æ˜¯');
       document.getElementById('longTerm_editStoreTransfer').value = order['åˆ†åº—èª¿æ’¥'] || '';
       document.getElementById('longTerm_editNotes').value = order['å‚™è¨»'] || order['èªªæ˜'] || '';
       
       try{
        const purchase = parseMultiDateStringToArray(order['æ¡è³¼æ—¥æœŸ']);
        const arrival = parseMultiDateStringToArray(order['åˆ°è²¨æ—¥æœŸ']);
        const pickup = parseMultiDateStringToArray(order['å–èµ°æ—¥æœŸ']);
        const missed = parseMultiDateStringToArray(order['æœªæ¥é›»è©±æ—¥æœŸ']);
        const notify = parseMultiDateStringToArray(order['é€šçŸ¥æ—¥æœŸ']);
        longTerm_editPurchaseCtrl.setItems(purchase);
        longTerm_editArrivalCtrl.setItems(arrival);
        longTerm_editPickupCtrl.setItems(pickup);
        longTerm_editMissedCtrl.setItems(missed);
        longTerm_editNotifyCtrl.setItems(notify);
      }catch(e){ console.warn(e); }

       longTermEditModal.classList.remove('hidden');
    }
    
    function openBlacklistEditModal(row) {
       document.getElementById('blacklist_editRowIndex').value = row['__row'];
       const data = resolveBlacklistRowData(row);
       document.getElementById('bl_edit_phone').value = data.phone;
       document.getElementById('bl_edit_name').value = data.name;
       document.getElementById('bl_edit_custID').value = data.id;
       document.getElementById('bl_edit_reason').value = data.reason;
       // ... note handling ...
       // If backend returns 'å‚™è¨»' or 'Note', map it
       let note = row['å‚™è¨»'] || row['Note'] || '';
       document.getElementById('bl_edit_notes').value = note;
       
       blacklistEditModal.classList.remove('hidden');
    }

    document.getElementById('closeEditModal').addEventListener('click', () => editModal.classList.add('hidden'));
    document.getElementById('longTerm_closeEditModal').addEventListener('click', () => longTermEditModal.classList.add('hidden'));
    document.getElementById('blacklist_closeEditModal').addEventListener('click', () => blacklistEditModal.classList.add('hidden'));
    
    // History Modal Logic
    searchHistoryBtn.addEventListener('click', () => {
        const store = storeSelect.value;
        if (!store) {
            alert('è«‹å…ˆé¸æ“‡åˆ†åº—æ‰èƒ½æŸ¥è©¢è©²åº—çš„æ­·å²è³‡æ–™');
            return;
        }
        // æ¸…ç©ºå‰æ¬¡æŸ¥è©¢
        historySearchInput.value = '';
        historyTableBody.innerHTML = '';
        historyTableHeaders.innerHTML = '';
        historyNoData.classList.add('hidden');
        
        // é¡¯ç¤ºæç¤ºæ–‡å­— (é¸ç”¨)
        historyNoData.textContent = 'è«‹è¼¸å…¥é—œéµå­—é€²è¡Œæœå°‹';
        historyNoData.classList.remove('hidden');
        
        historyModalBackdrop.classList.remove('hidden');
    });
    
    closeHistoryModal.addEventListener('click', () => {
        historyModalBackdrop.classList.add('hidden');
    });
    
    historySearchBtn.addEventListener('click', performHistorySearch);
    historySearchInput.addEventListener('keydown', (e) => { if(e.key==='Enter') performHistorySearch(); });
    
    async function performHistorySearch() {
        const store = storeSelect.value;
        const term = historySearchInput.value.trim(); // Keep original casing for display, convert for check
        
        if (!term) {
            alert('è«‹è¼¸å…¥æœå°‹é—œéµå­— (ä¾‹å¦‚å§“åã€é›»è©±æˆ–å•†å“åç¨±)');
            return;
        }
        
        historyLoader.classList.remove('hidden');
        historyTableBody.innerHTML = '';
        historyTableHeaders.innerHTML = ''; 
        historyNoData.classList.add('hidden');
        
        try {
            const url = `${SCRIPT_URL}?action=search_history&store=${encodeURIComponent(store)}&term=${encodeURIComponent(term)}`;
            const resp = await fetch(url);
            const json = await resp.json();
            
            if(json.result === 'success') {
                let rows = json.rows || [];
                const headers = json.headers || [];
                
                // === å‰ç«¯äºŒæ¬¡éæ¿¾ (Double Check) ===
                // ç¢ºä¿æœå°‹çµæœçœŸçš„åŒ…å«é—œéµå­— (æ’é™¤ç³»çµ±è‡ªå‹•ç”¢ç”Ÿçš„è¡Œè™Ÿ __row å¹²æ“¾)
                if (term) {
                    const lowerTerm = term.toLowerCase();
                    rows = rows.filter(r => {
                        return Object.entries(r).some(([key, val]) => {
                            // å¿½ç•¥è¡Œè™Ÿï¼Œåªæœå°‹å¯¦éš›è³‡æ–™
                            if (key === '__row') return false;
                            return String(val).toLowerCase().includes(lowerTerm);
                        });
                    });
                }
                
                if(rows.length === 0) {
                    historyNoData.textContent = 'æŸ¥ç„¡ç¬¦åˆè³‡æ–™';
                    historyNoData.classList.remove('hidden');
                } else {
                    renderHistoryTable(headers, rows);
                }
            } else {
                alert('æŸ¥è©¢å¤±æ•—ï¼š' + json.error);
            }
        } catch(e) {
            console.error(e);
            alert('æŸ¥è©¢éŒ¯èª¤');
        } finally {
            historyLoader.classList.add('hidden');
        }
    }
    
    function renderHistoryTable(headers, rows) {
        historyTableHeaders.innerHTML = '';
        
        // å®šç¾©è¦é¡¯ç¤ºçš„æ¬„ä½é—œéµå­—
        const displayCols = ['æ­¸æª”æ—¥æœŸ', 'å®¢è™Ÿ', 'å§“å', 'é›»è©±', 'é€£çµ¡é›»è©±', 'å®¢è¨‚å•†å“A', 'å•†å“', 'å–èµ°æ—¥æœŸ', 'å‚™è¨»'];
        
        // å»ºç«‹ã€Œæ¬„ä½åç¨±ã€æ¸…å–® (å–ä»£ç´¢å¼•ï¼Œé¿å…éŒ¯ä½)
        const colNames = [];
        
        headers.forEach(h => {
            // åˆ¤æ–·æ­¤æ¨™é¡Œæ˜¯å¦åŒ…å«æˆ‘å€‘è¦é¡¯ç¤ºçš„é—œéµå­—
            const shouldShow = displayCols.some(k => h.includes(k)) || h.includes('Date') || h.includes('æ—¥æœŸ');
            if(shouldShow) { 
                const th = document.createElement('th');
                th.textContent = h;
                th.className = "sticky top-0 bg-gray-100 px-4 py-2 border-b font-bold whitespace-nowrap";
                historyTableHeaders.appendChild(th);
                colNames.push(h); // è¨˜éŒ„æ¨™é¡Œåç¨±
            }
        });
        
        // æ¸²æŸ“è³‡æ–™åˆ—
        rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50 border-b";
            
            // ä¾æ“š colNames (æ¨™é¡Œåç¨±) ä¾†æŠ“å–å°æ‡‰è³‡æ–™
            colNames.forEach(key => {
                const td = document.createElement('td');
                td.className = "px-4 py-2 whitespace-nowrap text-sm";
                
                let val = row[key]; // ç›´æ¥ç”¨ Key å–å€¼ï¼Œæœ€æº–ç¢º
                
                // æ—¥æœŸç°¡å–®æ ¼å¼åŒ–
                if(typeof val === 'string' && val.includes('T') && val.includes(':')) {
                    val = val.split('T')[0]; 
                }
                
                td.textContent = (val !== undefined && val !== null) ? val : '-';
                tr.appendChild(td);
            });
            historyTableBody.appendChild(tr);
        });
    }

    // Forms
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const store = storeSelect.value;
      if(!store) { alert('è«‹é¸æ“‡åº—åˆ¥'); return; }
      submitButton.disabled = true; submitButton.textContent = 'é€å‡ºä¸­...';
      try {
        const fd = new FormData(form);
        fd.append('action', 'append');
        fd.append('store', store);
        await fetch(SCRIPT_URL, { method: 'POST', body: fd });
        alert('è¨‚å–®å·²é€å‡º'); form.reset(); fetchOrders();
      } catch(err) { alert('å¤±æ•—: '+err.message); } finally { submitButton.disabled = false; submitButton.textContent = 'é€å‡ºè¨‚å–®'; }
    });
    
    // ç›£è½é›»è©±è¼¸å…¥ (é»‘åå–®æª¢æŸ¥)
    const phoneInput = document.getElementById('phone');
    const phoneWarning = document.getElementById('phone-warning');
    phoneInput.addEventListener('input', function() {
      const inputVal = this.value.trim().replace(/\D/g, ''); 
      const inputNoZero = inputVal.replace(/^0+/, ''); 
      phoneWarning.classList.add('hidden');
      this.style.borderColor = ''; this.style.backgroundColor = '';
      if (inputNoZero.length < 6) return;
      
      const found = allBlacklistData.find(row => {
          const data = resolveBlacklistRowData(row);
          const rawPhone = data.phone;
          const rowPhoneNoZero = String(rawPhone).replace(/\D/g, '').replace(/^0+/, '');
          return rowPhoneNoZero && rowPhoneNoZero === inputNoZero;
      });

      if (found) {
           const data = resolveBlacklistRowData(found);
           phoneWarning.classList.remove('hidden');
           phoneWarning.textContent = `âš ï¸ æ­¤è™Ÿç¢¼åœ¨é»‘åå–®ä¸­ï¼(${data.reason})`;
           this.style.borderColor = 'red'; this.style.backgroundColor = '#fef2f2';
      }
    });

    // Store Settings (Lock & Notify)
    async function checkStoreSettings() {
      const store = storeSelect.value;
      if(!store) {
        // Reset controls
        storeLockCheckbox.checked = false;
        notifyToggle.checked = false;
        notifyToggle.disabled = true; // Disable visually
        return;
      }
      
      // === ä¿®æ­£ï¼šè®€å–è¨­å®šæ™‚ä½¿ç”¨åº—åè€Œéä»£ç¢¼ ===
      const storeName = getSelectedStoreName();
      if(!storeName) return;

      notifyToggle.disabled = false; // Enable interaction
      
      try {
        // å‚³é€åº—åè€Œé value
        const resp = await fetch(`${SCRIPT_URL}?action=get_store_settings&store=${encodeURIComponent(storeName)}`);
        const json = await resp.json();
        if (json.result === 'success') {
          // åªåœ¨éä½¿ç”¨è€…æ“ä½œæ™‚æ›´æ–° (é€™è£¡å…¶å¯¦æ˜¯è®€å–ä¼ºæœå™¨ç«¯çš„è¨­å®šç‹€æ…‹)
          // æ³¨æ„ï¼šå¦‚æœ storeLockCheckbox å‰›å‰›è¢«ä½¿ç”¨è€…é»æ“Šï¼Œé€™è£¡å¯èƒ½æœƒè¦†è“‹ç‹€æ…‹ï¼Œä½†é€šå¸¸ fetchStores -> checkStoreSettings æ˜¯åˆå§‹åŒ–æµç¨‹
          storeLockCheckbox.checked = (json.settings.locked === '1');
          notifyToggle.checked = (json.settings.notify_enabled === '1');
          
          if(json.settings.locked === '1') {
             storeSelect.classList.add('select-disabled');
             storeSelect.disabled = true;
             showTopMessage('åº—åˆ¥å·²é–å®š', false);
          } else {
             storeSelect.classList.remove('select-disabled');
             storeSelect.disabled = false;
             showTopMessage('', false);
          }
        }
      } catch(err) { console.warn('checkStoreSettings error', err); }
    }

    storeLockCheckbox.addEventListener('change', async () => {
      const store = storeSelect.value;
      const locked = storeLockCheckbox.checked;
      
      if(!store){ 
          showTopMessage('è«‹å…ˆé¸æ“‡åº—åˆ¥', true); 
          storeLockCheckbox.checked = false; 
          return; 
      }

      if(locked){
        storeSelect.classList.add('select-disabled');
        storeSelect.disabled = true;
      } else {
        storeSelect.classList.remove('select-disabled');
        storeSelect.disabled = false;
      }
      showTopMessage(locked ? 'åº—åˆ¥å·²é–å®š' : 'åº—åˆ¥å·²è§£é–', false);

      // === ä¿®æ­£ï¼šé–å®šæ™‚å‚³é€åº—å ===
      const storeName = getSelectedStoreName();
      const ok = await setStoreLockValue(locked);
      
      if(!ok){
        showTopMessage('è¨­å®šåº—åˆ¥é–å®šå¤±æ•—ï¼Œå·²é‚„åŸç‹€æ…‹', true);
        storeLockCheckbox.checked = !locked;
        if(!locked){ 
            storeSelect.classList.add('select-disabled');
            storeSelect.disabled = true;
        } else {
            storeSelect.classList.remove('select-disabled');
            storeSelect.disabled = false;
        }
      }
    });

    // Notify Toggle Listener
    notifyToggle.addEventListener('change', async (e) => {
        const store = storeSelect.value;
        // é˜²å‘†ï¼šæœªé¸å–åº—åˆ¥
        if (!store) {
            e.preventDefault();
            notifyToggle.checked = false; // å¼·åˆ¶é—œé–‰
            alert('æœªé¸å–åº—åˆ¥ç„¡æ³•é–‹å•Ÿé€¾æœŸLineé€šçŸ¥');
            return;
        }

        const isEnabled = notifyToggle.checked;
        const msg = isEnabled ? 'é–‹å•Ÿ' : 'é—œé–‰';
        
        // Optimistic update done by checkbox itself, now verify with backend
        try {
            // === ä¿®æ­£ï¼šé€šçŸ¥è¨­å®šå‚³é€åº—å ===
            const storeName = getSelectedStoreName();
            
            const params = new URLSearchParams();
            params.append('action', 'set_notify_status');
            params.append('store', storeName); // ä½¿ç”¨åº—å
            params.append('enabled', isEnabled ? '1' : '0');
            
            await fetch(SCRIPT_URL, { method: 'POST', body: params });
            showTopMessage(`å·²${msg}é€¾æœŸé€šçŸ¥`, false);
        } catch (err) {
            alert('è¨­å®šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
            notifyToggle.checked = !isEnabled; // Revert
        }
    });
    
    // === ä¿®æ­£ï¼šé‡æ•´åˆ†åº—æŒ‰éˆ•èªæ³•éŒ¯èª¤ ===
    document.getElementById('refreshStoresBtn').addEventListener('click', async()=>{ 
        const fd = new FormData();
        fd.append('action','create_store_sheets');
        await fetch(SCRIPT_URL,{method:'POST',body:fd}); 
        await fetchStores(); 
    });
    
    // Backup Button Listener
    document.getElementById('backupBtn').addEventListener('click', () => {
        const store = storeSelect.value;
        const storeName = getSelectedStoreName(); // ä½¿ç”¨æ­£ç¢ºçš„åº—åè®Šæ•¸
        
        let htmlContent = '';
        if (store) {
            htmlContent = `
              <p class="font-bold text-gray-800 mb-2">ç¢ºå®šè¦å‚™ä»½ [${storeName}] çš„è³‡æ–™å—ï¼Ÿ</p>
              <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                <li>ç³»çµ±å°‡æœƒå»ºç«‹ä¸€å€‹ç¨ç«‹çš„å‚™ä»½æª”æ¡ˆã€‚</li>
                <li>æª”æ¡ˆåç¨±å°‡åŒ…å«ç•¶å‰æ—¥æœŸæ™‚é–“ã€‚</li>
                <li>é€™ä¸æœƒå½±éŸ¿ç›®å‰çš„é‹ä½œã€‚</li>
              </ul>
            `;
        } else {
            htmlContent = `
              <p class="font-bold text-gray-800 mb-2">æ‚¨å°šæœªé¸æ“‡åˆ†åº—ï¼Œç³»çµ±å°‡åŸ·è¡Œã€å®Œæ•´å‚™ä»½ã€‘ã€‚</p>
              <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                <li>å‚™ä»½å…§å®¹åŒ…å«æ‰€æœ‰åˆ†åº—è¨‚å–®ã€é»‘åå–®èˆ‡è¨­å®šã€‚</li>
                <li>æª”æ¡ˆè¼ƒå¤§ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚</li>
              </ul>
            `;
        }
        
        backupModalContent.innerHTML = htmlContent;
        backupModalBackdrop.classList.remove('hidden');
    });

    closeBackupModal.addEventListener('click', () => backupModalBackdrop.classList.add('hidden'));
    cancelBackupBtn.addEventListener('click', () => backupModalBackdrop.classList.add('hidden'));
    
    confirmBackupBtn.addEventListener('click', async () => {
        confirmBackupBtn.disabled = true;
        confirmBackupBtn.textContent = 'å‚™ä»½ä¸­...';
        
        const store = storeSelect.value;
        const storeName = getSelectedStoreName();
        
        try {
            // === ä¿®æ­£ï¼šå‚™ä»½åŠŸèƒ½æ”¹ç”¨ URLSearchParams ç¢ºä¿åƒæ•¸æ­£ç¢ºå‚³é ===
            const params = new URLSearchParams();
            params.append('action', 'backup_database');
            // ä¿®æ­£ï¼šå‚™ä»½æŒ‡å®šåˆ†åº—æ™‚ï¼Œå‚³é€ Store Name è€Œé Code
            if(store) params.append('store', storeName);
            
            const resp = await fetch(SCRIPT_URL, { method: 'POST', body: params });
            const json = await resp.json();
            
            if (json.result === 'success') {
                alert(json.message || 'å‚™ä»½æˆåŠŸï¼');
                backupModalBackdrop.classList.add('hidden');
            } else {
                alert('å‚™ä»½å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
        } catch (e) {
            alert('å‚™ä»½è«‹æ±‚å¤±æ•—ï¼š' + e.message);
        } finally {
            confirmBackupBtn.disabled = false;
            confirmBackupBtn.textContent = 'ç¢ºèªå‚™ä»½';
        }
    });

    // Clear Overdue Listener (Manual Trigger)
    document.getElementById('clearOverdueBtn').addEventListener('click', async () => {
        const store = storeSelect.value;
        if (!store) {
            alert('è«‹å…ˆé¸æ“‡è¦æ•´ç†çš„åˆ†åº—ï¼');
            return;
        }
        
        if (!confirm('ç¢ºå®šè¦æ•´ç†æ­¤åˆ†åº—çš„éæœŸè³‡æ–™å—ï¼Ÿ\n\nè¦å‰‡ï¼š\n1. å·²å–èµ°ä¸”è¶…é 5 å¤©çš„è³‡æ–™ -> ç§»è‡³æ­·å²è³‡æ–™åº«ä¸¦åˆªé™¤ã€‚\n2. æœªå®Œæˆçš„è¨‚å–®ä¸æœƒè¢«åˆªé™¤ã€‚')) return;
        
        const btn = document.getElementById('clearOverdueBtn');
        btn.disabled = true;
        btn.textContent = 'æ•´ç†ä¸­...';
        
        try {
            // === ä¿®æ­£ï¼šæ¸…é™¤é€¾æœŸä¹Ÿæ”¹é€åº—åï¼Œç¢ºä¿å¾Œç«¯èƒ½æŠ“åˆ°æ­£ç¢ºå·¥ä½œè¡¨ ===
            const storeName = getSelectedStoreName();
            const fd = new FormData();
            fd.append('action', 'clean_overdue');
            fd.append('store', storeName); 
            
            const resp = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
            const json = await resp.json();
            if (json.result === 'success') {
                alert(json.message);
                fetchOrders(); // Refresh table
            } else {
                alert('æ•´ç†å¤±æ•—ï¼š' + json.error);
            }
        } catch(e) {
            alert('è«‹æ±‚å¤±æ•—ï¼š' + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'æ¸…é™¤é€¾æœŸ';
        }
    });

    // Blacklist
    async function fetchBlacklistData() {
      document.getElementById('blacklist_dataLoader').classList.remove('hidden');
      try {
        const resp = await fetch(`${SCRIPT_URL}?action=blacklist`);
        const json = await resp.json();
        allBlacklistData = json.rows || [];
        renderBlacklistTable();
      } catch(e) { console.error(e); } finally { document.getElementById('blacklist_dataLoader').classList.add('hidden'); }
    }
    
    // Helper to resolve blacklist row data flexibly
    function resolveBlacklistRowData(row) {
      const keys = Object.keys(row);
      const findKey = (candidates) => {
        for (const c of candidates) {
          if (row[c] !== undefined) return c;
        }
        for (const c of candidates) {
          const found = keys.find(k => k.includes(c));
          if (found) return found;
        }
        return null;
      };

      const idKey = findKey(['å®¢è™Ÿ', 'Cust', 'ID', 'ç·¨è™Ÿ']);
      const nameKey = findKey(['å§“å', 'Name', 'é¡§å®¢']);
      const phoneKey = findKey(['é›»è©±', 'Phone', 'Mobile', 'æ‰‹æ©Ÿ', 'é€£çµ¡']);
      const reasonKey = findKey(['åŸå› ', 'Reason', 'äº‹ç”±', 'å‚™è¨»', 'èªªæ˜']);
      const dateKey = findKey(['æ—¥æœŸ', 'Date', 'Time']);
      const storeKey = findKey(['åº—åˆ¥', 'Store', 'åˆ†åº—', 'StoreName']); 

      return {
        id: idKey ? row[idKey] : '-',
        name: nameKey ? row[nameKey] : 'æœªçŸ¥',
        phone: phoneKey ? row[phoneKey] : '',
        reason: reasonKey ? row[reasonKey] : '',
        date: dateKey ? row[dateKey] : '',
        store: storeKey ? row[storeKey] : ''
      };
    }
    
    function renderBlacklistTable() {
      const tbody = document.getElementById('blacklist_data-table-body');
      const noData = document.getElementById('blacklist_noDataText');
      const tableContainer = document.getElementById('blacklist_dataTableContainer');
      tbody.innerHTML = '';
      const term = document.getElementById('blacklist_searchInput').value.trim().toLowerCase();
      
      const filtered = allBlacklistData.filter(row => {
         if(!term) return true;
         // Search all values in row
         return Object.values(row).some(val => String(val).toLowerCase().includes(term));
      });
      
      if(filtered.length === 0) { 
        noData.classList.remove('hidden'); 
        tableContainer.classList.add('hidden'); 
        return; 
      }
      else { 
        noData.classList.add('hidden'); 
        tableContainer.classList.remove('hidden'); 
      }
      
      filtered.forEach(row => {
         const tr = document.createElement('tr');
         tr.className = 'hover:bg-red-50 cursor-pointer';
         tr.onclick = (e) => { if(e.target.closest('button')) return; openBlacklistEditModal(row); };
         
         const data = resolveBlacklistRowData(row);
         const dateVal = formatFieldValueIfDate('æ—¥æœŸ', data.date);
         const phoneVal = formatPhone(data.phone);

         // === ä¿®æ­£ï¼šè½‰æ›åº—åˆ¥ä»£ç¢¼ç‚ºä¸­æ–‡åº—å ===
         let displayStoreName = data.store;
         if (allStoresCache && allStoresCache.length > 0) {
             const match = allStoresCache.find(s => s.code === data.store);
             if (match && match.name) displayStoreName = match.name;
         }

         tr.innerHTML = `
           <td class="status-badge missed">é»‘åå–®</td>
           <td class="text-center"> <!-- FIXED: Center delete button -->
               <button type="button" class="btn bg-red-100 text-red-600 px-2 py-1 text-xs" onclick="event.stopPropagation(); deleteBlacklistRow(${row['__row']})">åˆªé™¤</button>
           </td>
           <td data-label="å®¢è™Ÿ">${data.id}</td>
           <td data-label="å§“å">${data.name}</td>
           <td data-label="é›»è©±">${phoneVal}</td>
           <td data-label="åº—åˆ¥">${displayStoreName}</td>
           <td data-label="åŸå› " class="text-red-600">${data.reason}</td>
           <td data-label="æ—¥æœŸ">${dateVal}</td>
         `;
         
         tbody.appendChild(tr);
      });
    }
    
    async function deleteBlacklistRow(rowIndex) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é»‘åå–®è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
      try {
        const fd = new FormData();
        fd.append('action', 'delete');
        fd.append('row', rowIndex);
        fd.append('targetSheet', 'blacklist'); // Ensure 'blacklist' matches backend expectation
        const resp = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
        const json = await resp.json();
        if (json.result === 'success') {
          alert('åˆªé™¤æˆåŠŸ');
          fetchBlacklistData();
        } else {
          alert('åˆªé™¤å¤±æ•—ï¼š' + json.error);
        }
      } catch(e) {
        alert('åˆªé™¤å¤±æ•—ï¼š' + e.message);
      }
    }

    document.getElementById('blacklist_searchButton').addEventListener('click', renderBlacklistTable);
    document.getElementById('blacklist_searchInput').addEventListener('input', renderBlacklistTable);
    document.getElementById('longTerm_searchButton').addEventListener('click', renderLongTermTable);
    document.getElementById('longTerm_searchInput').addEventListener('input', renderLongTermTable);
    document.getElementById('searchButton').addEventListener('click', renderTable);
    document.getElementById('searchInput').addEventListener('input', renderTable);

    document.getElementById('blacklist_addButton').addEventListener('click', () => { 
        const currentStoreVal = storeSelect.value;
        if(currentStoreVal) {
            // ä¿®æ”¹ï¼šæŠ“å–é¸å–®æ–‡å­—(åº—å)è€Œéå€¼(åº—è™Ÿ)
            const currentStoreName = storeSelect.options[storeSelect.selectedIndex].text;
            document.getElementById('blacklist_addStore').value = currentStoreName;
        }
        document.getElementById('blacklist_addModalBackdrop').classList.remove('hidden'); 
    });
    document.getElementById('blacklist_closeAddModal').addEventListener('click', () => document.getElementById('blacklist_addModalBackdrop').classList.add('hidden'));
    
    document.getElementById('blacklist_addForm').addEventListener('submit', async(e)=>{
       e.preventDefault();
       try { 
         const fd = new FormData(e.target); 
         fd.append('action', 'add_blacklist'); 
         fd.append('targetSheet', 'blacklist');
         
         // å–å¾—ç•¶å‰æ—¥æœŸèˆ‡åº—åˆ¥
         const today = todayLocalForInput();
         const currentStore = document.getElementById('blacklist_addStore').value;

         // --- å¼·åˆ¶å¯«å…¥å¤šç¨®å¸¸è¦‹æ¬„ä½åç¨±ï¼Œç¢ºä¿å¾Œç«¯èƒ½æŠ“åˆ°å…¶ä¸­ä¸€å€‹ ---
         // æ—¥æœŸç›¸é—œ
         fd.append('æ—¥æœŸ', today);
         fd.append('Date', today);
         fd.append('å»ºç«‹æ—¥æœŸ', today);
         fd.append('æ™‚é–“', today);
         
         // åº—åˆ¥ç›¸é—œ
         if(currentStore) {
             fd.append('åº—åˆ¥', currentStore);
             fd.append('åˆ†åº—', currentStore);
             fd.append('Store', currentStore);
             fd.append('StoreName', currentStore);
         }
         
         await fetch(SCRIPT_URL, {method:'POST', body:fd}); 
         alert('æ–°å¢æˆåŠŸ'); 
         e.target.reset(); 
         document.getElementById('blacklist_addModalBackdrop').classList.add('hidden'); 
         fetchBlacklistData(); 
       } catch(e) { alert('å¤±æ•—: ' + e.message); }
    });
    
    // Modal Submits
    document.getElementById('editForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const fd=new FormData(e.target); fd.append('action','update'); fd.append('store',storeSelect.value); await fetch(SCRIPT_URL,{method:'POST',body:fd}); alert('æ›´æ–°æˆåŠŸ'); editModal.classList.add('hidden'); fetchOrders(); });
    document.getElementById('longTerm_editForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const fd=new FormData(e.target); fd.append('action','update'); fd.append('store',storeSelect.value); await fetch(SCRIPT_URL,{method:'POST',body:fd}); alert('æ›´æ–°æˆåŠŸ'); longTermEditModal.classList.add('hidden'); fetchOrders(); });
    document.getElementById('blacklist_editForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const fd=new FormData(e.target); fd.append('action','update'); fd.append('targetSheet','blacklist'); await fetch(SCRIPT_URL,{method:'POST',body:fd}); alert('æ›´æ–°æˆåŠŸ'); blacklistEditModal.classList.add('hidden'); fetchBlacklistData(); });
    
    // Deletes
    document.getElementById('deleteEdit').addEventListener('click', ()=>{ if(confirm('åˆªé™¤?')) deleteRow(document.getElementById('editRowIndex').value); });
    document.getElementById('longTerm_deleteEdit').addEventListener('click', ()=>{ if(confirm('åˆªé™¤?')) deleteRow(document.getElementById('longTerm_editRowIndex').value); });
    async function deleteRow(idx) { const fd=new FormData(); fd.append('action','delete'); fd.append('row',idx); fd.append('store',storeSelect.value); await fetch(SCRIPT_URL,{method:'POST',body:fd}); alert('å·²åˆªé™¤'); editModal.classList.add('hidden'); longTermEditModal.classList.add('hidden'); fetchOrders(); }

    document.querySelectorAll('[data-target]').forEach(btn => {
      btn.addEventListener('click', () => { document.getElementById(btn.dataset.target).value = todayLocalForInput(); });
    });
    
    // Cancel buttons for Blacklist modals
    document.getElementById('blacklist_cancelAdd').addEventListener('click', () => { document.getElementById('blacklist_addModalBackdrop').classList.add('hidden'); });
    document.getElementById('blacklist_cancelEdit').addEventListener('click', () => { document.getElementById('blacklist_editModalBackdrop').classList.add('hidden'); });

    async function setStoreLockValue(locked){
      if(!store) return;
      try{
        // === ä¿®æ­£ï¼šé–å®šåŠŸèƒ½æ”¹ç”¨ URLSearchParams ç¢ºä¿åƒæ•¸æ­£ç¢ºå‚³é ===
        const params = new URLSearchParams();
        params.append('action', 'set_store_lock');
        params.append('store', getSelectedStoreName());
        params.append('locked', locked ? '1' : '0');
        
        const resp = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: params 
        });
        const json = await resp.json();
        return json && json.result === 'success';
      }catch(err){ console.warn('setStoreLockValue error', err); return false; }
    }

  </script>
</body>
</html>
