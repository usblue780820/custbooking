<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å®¢è¨‚ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --label-w: 6rem; }
    body { 
      font-family: "Inter", system-ui, -apple-system, sans-serif; 
      background-color: #f3f4f6;
      font-size: 14px; /* åŸºåº•å­—é«”ç¸®å° */
    }
    .no-wrap-label { white-space: nowrap; }
    
    /* å„ªåŒ–å¾Œçš„è¡¨æ ¼å®¹å™¨ */
    .table-container {
      width: 100%;
      max-height: 65vh; /* å¢åŠ å¯è¦–é«˜åº¦ */
      overflow: auto;
      position: relative;
      -webkit-overflow-scrolling: touch;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      background-color: white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .table-container table { width: 100%; border-collapse: separate; border-spacing: 0; } 
    
    /* ç·Šæ¹Šå‹å„²å­˜æ ¼ */
    .table-container td {
      background-color: white;
      border-bottom: 1px solid #f3f4f6;
      padding: 0.35rem 0.5rem; /* å¤§å¹…æ¸›å°‘ padding */
      font-size: 0.85rem;
      color: #374151;
      white-space: nowrap;
      text-align: center;
      vertical-align: middle;
    }

    /* ç·Šæ¹Šå‹è¡¨é ­ */
    .table-container th {
      position: sticky;
      top: 0;
      z-index: 30;
      background-color: #f9fafb;
      color: #1f2937;
      font-weight: 700;
      font-size: 0.8rem;
      padding: 0.4rem 0.5rem;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
      text-align: center;
      vertical-align: middle;
      box-shadow: 0 1px 1px rgba(0,0,0,0.05);
    }
    .table-container tr:hover td { background-color: #f0f9ff; }
    
    /* æ¨™ç±¤æ¨£å¼å„ªåŒ– */
    .tag { display:inline-flex; align-items:center; padding:0 0.5rem; margin:0.1rem; font-size:0.75rem; background:#e5e7eb; color:#374151; border-radius:4px; height: 24px; }
    .tag .remove { margin-left:0.25rem; cursor:pointer; font-weight:bold; color:#9ca3af; }
    
    /* ç‹€æ…‹æ¨™ç±¤å¾®èª¿ */
    .status-tag { display:inline-flex; align-items:center; gap:0.25rem; padding:0.15rem 0.5rem; border-radius:999px; font-weight:600; font-size:0.75rem; border: 1px solid transparent; }
    .status-paw { width:12px; height:12px; }
    
    .status-pending { background:#f3f4f6; color:#4b5563; border-color:#d1d5db; }
    .status-purchase { background:#e0e7ff; color:#3730a3; border-color:#c7d2fe; }
    .status-arrived { background:#f3e8ff; color:#6b21a8; border-color:#e9d5ff; }
    .status-missed { background:#fff7ed; color:#9a3412; border-color:#ffedd5; }
    .status-notified { background:#e0f2fe; color:#0369a1; border-color:#bae6fd; }
    .status-closed { background:#dcfce7; color:#14532d; border-color:#bbf7d0; }
    
    .loader { border:3px solid #f3f4f3; border-top:3px solid #3b82f6; border-radius:50%; width:30px; height:30px; animation:spin 0.8s linear infinite; margin:10px auto; }
    @keyframes spin { 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }
    
    /* Modal å„ªåŒ– */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:50; backdrop-filter: blur(2px); }
    .modal { background:white; border-radius:0.5rem; width:95%; max-width:800px; max-height:95vh; overflow-y:auto; padding:1rem; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
    
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:0.25rem; padding:0.4rem 0.8rem; border-radius:0.375rem; font-size: 0.9rem; font-weight:500; cursor: pointer; transition: all 0.2s; }
    .btn:active { transform: scale(0.98); }
    
    /* æ‰‹æ©Ÿç‰ˆå„ªåŒ–è¼¸å…¥æ¡† */
    input[type="text"], input[type="tel"], input[type="number"], input[type="date"], select, textarea {
      font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
      padding: 0.4rem 0.5rem;
    }

    .topbar { background: white; display:flex; flex-wrap: wrap; gap:0.5rem; align-items:center; padding:0.5rem; border-radius:0.375rem; border: 1px solid #e5e7eb; }
    
    /* ç‹€æ…‹ Tab å„ªåŒ– */
    .status-tabs { display:flex; gap:0.35rem; margin-bottom:0.5rem; }
    .status-tab { 
      padding:0.35rem 0.75rem; border-radius:999px; background:#fff; cursor:pointer; font-size: 0.8rem; font-weight:500; color:#4b5563; 
      border:1px solid #e5e7eb; white-space: nowrap;
    }
    .status-tab.active { background:#4f46e5; color:white; border-color:#4338ca; }
    .status-tab.all { font-weight: 700; }
    .status-tabs-scroll { overflow-x:auto; padding-bottom:4px; margin-bottom: 0.5rem; -webkit-overflow-scrolling: touch; display: flex; }
    
    /* æ”¶æŠ˜é¢æ¿æ¨£å¼ */
    .accordion-header { cursor: pointer; user-select: none; }
    .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s; overflow: hidden; max-height: 0; opacity: 0; }
    .accordion-content.open { max-height: 2000px; opacity: 1; }
    .arrow-icon { transition: transform 0.3s; }
    .arrow-icon.open { transform: rotate(180deg); }

    /* é»‘åå–®è­¦ç¤º */
    #blacklist-alert-bar {
      position: fixed; bottom: 0; left: 0; right: 0; background-color: #ef4444; color: white; padding: 0.75rem; text-align: center; font-weight: bold; z-index: 9999; display: none;
    }
    
    /* æ‰‹æ©Ÿç‰ˆ Grid å„ªåŒ– class */
    .grid-dense { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    .col-span-2 { grid-column: span 2; }

    /* å¹³æ¿ä»¥ä¸Š */
    @media (min-width: 768px) {
      .grid-md-3 { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body class="text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-200">
    <div class="max-w-full mx-auto px-3 py-2 flex items-center justify-between">
      <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
        <span class="text-xl">ğŸ¾</span> å®¢è¨‚ç³»çµ±
      </h1>
      <div class="text-xs text-gray-500" id="currentStoreDisplay"></div>
    </div>
  </header>

  <div class="max-w-full mx-auto p-2 space-y-3 pb-10">

    <!-- Top Controls -->
    <div class="bg-white p-2 rounded shadow-sm border border-gray-200">
      <div class="flex flex-col md:flex-row gap-2 items-center justify-between">
        <div class="flex items-center gap-2 w-full md:w-auto flex-wrap">
          <select id="storeSelect" class="flex-1 md:flex-none border border-gray-300 rounded px-2 py-1.5 text-sm bg-gray-50 max-w-[200px]"></select>
          <label class="flex items-center gap-1.5 text-sm cursor-pointer select-none bg-gray-50 px-2 py-1.5 rounded border border-gray-200">
            <input id="storeLockCheckbox" type="checkbox" class="rounded text-indigo-600 focus:ring-indigo-500" />
            <span>é–å®š</span>
          </label>
          <button id="refreshStoresBtn" class="btn bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200 text-xs px-2 whitespace-nowrap">é‡æ•´</button>
        </div>
        <div class="flex items-center justify-end w-full md:w-auto">
          <div id="top-message" class="text-xs text-red-600 font-medium hidden"></div>
        </div>
      </div>
    </div>

    <!-- æ–°å¢è¨‚å–® Form (Accordion) -->
    <div class="bg-white rounded shadow-sm border border-gray-200 overflow-hidden">
      <div id="formToggleBtn" class="accordion-header bg-indigo-50 p-3 flex items-center justify-between border-b border-indigo-100">
        <h2 class="font-bold text-indigo-800 text-sm flex items-center gap-2">
          <span>ğŸ“ æ–°å¢å®¢è¨‚å–®</span>
          <span class="text-xs font-normal text-indigo-500">(é»æ“Šå±•é–‹/æ”¶åˆ)</span>
        </h2>
        <svg class="arrow-icon w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
      </div>

      <div id="formContent" class="accordion-content">
        <form id="orderForm" class="p-3 bg-white">
          <div class="flex flex-col lg:flex-row gap-4">
            
            <!-- Customer Section -->
            <div class="flex-1 space-y-3">
              <div class="bg-gray-50 p-2.5 rounded border border-gray-100">
                <div class="text-xs font-bold text-gray-500 uppercase mb-2 tracking-wider">é¡§å®¢è³‡æ–™</div>
                <!-- æ‰‹æ©Ÿç‰ˆå…©æ¬„æ’åˆ— -->
                <div class="grid-dense">
                   <div class="col-span-1">
                     <label class="block text-xs font-medium text-gray-500 mb-1">å®¢è™Ÿ</label>
                     <input id="customerID" name="å®¢è™Ÿ" type="text" class="w-full border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" placeholder="ä¾‹å¦‚: 12345" />
                   </div>
                   <div class="col-span-1">
                     <label class="block text-xs font-medium text-gray-500 mb-1">å§“å</label>
                     <input id="customerName" name="å§“å" type="text" class="w-full border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
                   </div>
                   <div class="col-span-1">
                     <label class="block text-xs font-medium text-gray-500 mb-1">é›»è©±</label>
                     <input id="phone" name="é€£çµ¡é›»è©±" type="tel" class="w-full border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-colors" />
                   </div>
                   <div class="col-span-1">
                     <label class="block text-xs font-medium text-gray-500 mb-1">LINEåç¨±</label>
                     <input id="lineName" name="LINEåç¨±" type="text" class="w-full border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
                   </div>
                   <div class="col-span-2 flex gap-4 pt-1">
                      <label class="flex items-center gap-2 text-sm cursor-pointer">
                        <input id="paid" name="paid" type="checkbox" value="æ˜¯" class="rounded text-indigo-600 focus:ring-indigo-500" />
                        <span class="text-gray-700">å·²ä»˜æ¸…</span>
                      </label>
                      <label class="flex items-center gap-2 text-sm cursor-pointer">
                        <input id="longTerm" name="å›ºå®š/é•·æœŸå®¢è¨‚" type="checkbox" value="æ˜¯" class="rounded text-indigo-600 focus:ring-indigo-500" />
                        <span class="text-gray-700">é•·æœŸå®¢è¨‚</span>
                      </label>
                   </div>
                   <!-- è­¦å‘Šè¨Šæ¯ -->
                   <div id="phone-warning" class="col-span-2 text-xs text-red-600 font-bold hidden bg-red-50 p-1 rounded"></div>
                   
                   <div class="col-span-2">
                     <label class="block text-xs font-medium text-gray-500 mb-1">å‚™è¨»</label>
                     <textarea id="notes" name="å‚™è¨»" rows="1" class="w-full border-gray-300 rounded shadow-sm text-sm" placeholder="å‚™è¨»äº‹é …..."></textarea>
                   </div>
                </div>
              </div>
            </div>

            <!-- Product Section -->
            <div class="flex-1 space-y-3">
              
              <!-- Product A -->
              <div class="bg-indigo-50/50 p-2.5 rounded border border-indigo-100">
                <div class="text-xs font-bold text-indigo-600 uppercase mb-2 tracking-wider flex justify-between">
                  <span>å®¢è¨‚å•†å“ A (å¿…å¡«)</span>
                </div>
                <div class="grid grid-cols-12 gap-2">
                  <div class="col-span-12">
                     <input id="productAName" name="å®¢è¨‚å•†å“A" type="text" required class="w-full border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" placeholder="å•†å“åç¨±" />
                  </div>
                  <div class="col-span-8">
                     <input id="productASpec" name="Aå•†å“è¦æ ¼" type="text" class="w-full border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" placeholder="è¦æ ¼/é‡é‡" />
                  </div>
                  <div class="col-span-4">
                     <input id="productAQty" name="Aæ•¸é‡" type="number" min="1" required class="w-full border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-center" placeholder="æ•¸é‡" />
                  </div>
                </div>
              </div>

              <!-- Product B -->
              <div class="bg-gray-50 p-2.5 rounded border border-gray-100">
                <div class="text-xs font-bold text-gray-500 uppercase mb-2 tracking-wider">å®¢è¨‚å•†å“ B (é¸å¡«)</div>
                <div class="grid grid-cols-12 gap-2">
                  <div class="col-span-12">
                     <input id="productBName" name="å®¢è¨‚å•†å“B" type="text" class="w-full border-gray-300 rounded shadow-sm" placeholder="å•†å“åç¨±" />
                  </div>
                  <div class="col-span-8">
                     <input id="productBSpec" name="Bå•†å“è¦æ ¼" type="text" class="w-full border-gray-300 rounded shadow-sm" placeholder="è¦æ ¼/é‡é‡" />
                  </div>
                  <div class="col-span-4">
                     <input id="productBQty" name="Bæ•¸é‡" type="number" min="1" class="w-full border-gray-300 rounded shadow-sm text-center" placeholder="æ•¸é‡" />
                  </div>
                </div>
              </div>
              
            </div>
          </div>

          <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col items-center">
            <button type="submit" id="submitButton" class="w-full md:w-1/2 bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded shadow transition-colors flex items-center justify-center gap-2">
              <span>é€å‡ºè¨‚å–®</span>
            </button>
            <div id="message-box" class="hidden mt-2 w-full text-center text-sm p-2 rounded"></div>
          </div>
        </form>
      </div>
    </div>

    <!-- Data Query Section -->
    <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold text-gray-800">ğŸ“‹ å®¢è¨‚è³‡æ–™</h2>
        <div class="text-xs text-gray-500">ç›´æ¥é»æ“Šç·¨è¼¯</div>
      </div>

      <!-- Controls -->
      <div class="flex flex-col gap-2 mb-3">
        <div class="flex gap-2">
          <input id="searchInput" type="text" placeholder="æœå°‹å®¢è™Ÿã€å§“åã€é›»è©±..." class="flex-1 border-gray-300 rounded shadow-sm text-sm" />
          <button id="searchButton" type="button" class="btn bg-indigo-600 text-white hover:bg-indigo-700 whitespace-nowrap">æœå°‹</button>
        </div>
        <div class="flex gap-2 overflow-x-auto pb-1">
          <button id="refreshButton" type="button" class="btn bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 whitespace-nowrap text-xs">é‡æ•´</button>
          <button id="clearOverdueBtn" type="button" class="btn bg-orange-50 border border-orange-200 text-orange-700 hover:bg-orange-100 whitespace-nowrap text-xs">æ¸…é™¤é€¾æœŸ</button>
        </div>
      </div>

      <!-- Tabs -->
      <div id="statusTabsContainer">
        <div class="status-tabs-scroll">
          <div id="statusTabs" class="status-tabs"></div>
        </div>
      </div>

      <div id="data-message-box" class="hidden p-2 mb-2 rounded text-sm text-center"></div>

      <div id="dataContainer">
        <div id="dataLoader" class="loader hidden"></div>
        <p id="noDataText" class="text-center text-gray-400 text-sm py-4 hidden">æš«ç„¡è³‡æ–™</p>
        <div id="dataTableContainer" class="table-container hidden">
          <table class="min-w-full">
            <thead><tr id="data-table-headers"></tr></thead>
            <tbody id="data-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Long Term Section -->
    <div class="bg-white p-3 rounded shadow-sm border border-gray-200 mt-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold text-blue-800">ğŸ“… é•·æœŸå®¢è¨‚</h2>
      </div>

      <div class="flex gap-2 mb-3">
        <input id="longTerm_searchInput" type="text" placeholder="æœå°‹é•·æœŸå®¢è¨‚..." class="flex-1 border-gray-300 rounded shadow-sm text-sm" />
        <button id="longTerm_searchButton" type="button" class="btn bg-blue-600 text-white hover:bg-blue-700">æœå°‹</button>
        <button id="longTerm_refreshButton" type="button" class="btn bg-white border border-gray-300 text-gray-600">â†º</button>
      </div>

      <div id="ltStatusTabsContainer">
        <div class="status-tabs-scroll">
          <div id="ltStatusTabs" class="status-tabs"></div>
        </div>
      </div>

      <div id="longTerm_data-message-box" class="hidden p-2 mb-2 rounded text-sm"></div>

      <div id="longTerm_dataContainer">
        <div id="longTerm_dataLoader" class="loader hidden"></div>
        <p id="longTerm_noDataText" class="text-center text-gray-400 text-sm py-4 hidden">ç„¡è³‡æ–™</p>
        <div id="longTerm_dataTableContainer" class="table-container hidden">
          <table class="min-w-full">
            <thead><tr id="longTerm_data-table-headers"></tr></thead>
            <tbody id="longTerm_data-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Blacklist Section -->
    <div class="bg-white p-3 rounded shadow-sm border border-red-200 mt-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold text-red-700">ğŸš« é»‘åå–®</h2>
        <button id="blacklist_addButton" type="button" class="btn bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 text-xs">æ–°å¢</button>
      </div>

      <div class="flex gap-2 mb-3">
        <input id="blacklist_searchInput" type="text" placeholder="æœå°‹é»‘åå–®..." class="flex-1 border-gray-300 rounded shadow-sm text-sm" />
        <button id="blacklist_searchButton" type="button" class="btn bg-gray-600 text-white hover:bg-gray-700">æœå°‹</button>
        <button id="blacklist_refreshButton" type="button" class="btn bg-white border border-gray-300 text-gray-600">â†º</button>
      </div>

      <div id="blacklist_dataContainer">
        <div id="blacklist_dataLoader" class="loader hidden"></div>
        <p id="blacklist_noDataText" class="text-center text-gray-400 text-sm py-4 hidden">ç„¡é»‘åå–®</p>
        <div id="blacklist_dataTableContainer" class="table-container hidden">
          <table class="min-w-full">
            <thead><tr id="blacklist_data-table-headers"></tr></thead>
            <tbody id="blacklist_data-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Alert Bar -->
  <div id="blacklist-alert-bar"></div>

  <!-- Edit Modal (Simplified Layout) -->
  <div id="editModalBackdrop" class="modal-backdrop hidden">
    <div class="modal flex flex-col">
      <div class="flex items-center justify-between mb-3 border-b pb-2">
        <h3 id="editModalTitle" class="text-lg font-bold text-gray-800">ç·¨è¼¯è¨‚å–®</h3>
        <button id="closeEditModal" class="p-2 text-gray-500 hover:bg-gray-100 rounded text-xl">&times;</button>
      </div>
      <form id="editForm" class="flex-1 overflow-y-auto pr-1 space-y-3">
        <input type="hidden" id="editRowIndex" name="row" />
        <input type="hidden" id="editLongTermHidden" /> 
        
        <!-- Modal Grid Layout -->
        <div class="grid grid-cols-2 gap-3">
           <div class="col-span-1">
             <label class="text-xs text-gray-500 block mb-1">å®¢è™Ÿ</label>
             <input id="editCustomerID" name="å®¢è™Ÿ" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm" />
           </div>
           <div class="col-span-1">
             <label class="text-xs text-gray-500 block mb-1">å§“å</label>
             <input id="editCustomerName" name="å§“å" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm" />
           </div>
           <div class="col-span-2">
             <label class="text-xs text-gray-500 block mb-1">é›»è©±</label>
             <input id="editPhone" name="é€£çµ¡é›»è©±" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm" />
           </div>

           <!-- Product A -->
           <div class="col-span-2 bg-gray-50 p-2 rounded border border-gray-100">
             <div class="text-xs font-bold text-gray-400 mb-1">å•†å“ A</div>
             <div class="grid grid-cols-12 gap-2">
               <div class="col-span-12"><input id="editProductAName" name="å®¢è¨‚å•†å“A" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm" placeholder="å“å" /></div>
               <div class="col-span-8"><input id="editProductASpec" name="Aå•†å“è¦æ ¼" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm" placeholder="è¦æ ¼" /></div>
               <div class="col-span-4"><input id="editProductAQty" name="Aæ•¸é‡" type="number" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm text-center" placeholder="æ•¸é‡" /></div>
             </div>
           </div>

           <!-- Product B -->
           <div class="col-span-2 bg-gray-50 p-2 rounded border border-gray-100">
             <div class="text-xs font-bold text-gray-400 mb-1">å•†å“ B</div>
             <div class="grid grid-cols-12 gap-2">
               <div class="col-span-12"><input id="editProductBName" name="å®¢è¨‚å•†å“B" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm" placeholder="å“å" /></div>
               <div class="col-span-8"><input id="editProductBSpec" name="Bå•†å“è¦æ ¼" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm" placeholder="è¦æ ¼" /></div>
               <div class="col-span-4"><input id="editProductBQty" name="Bæ•¸é‡" type="number" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm text-center" placeholder="æ•¸é‡" /></div>
             </div>
           </div>

           <!-- Dates -->
           <div class="col-span-2 space-y-2">
             <div class="flex items-center gap-2">
               <span class="text-xs text-gray-500 w-16">æ¡è³¼æ—¥æœŸ</span>
               <input id="editPurchaseDate" name="æ¡è³¼æ—¥æœŸ" type="date" class="flex-1 border-gray-300 rounded py-1 px-2 text-sm" />
               <button type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2" data-target="editPurchaseDate">ä»Šå¤©</button>
             </div>
             <div class="flex items-center gap-2">
               <span class="text-xs text-gray-500 w-16">åˆ°è²¨æ—¥æœŸ</span>
               <input id="editArrivalDate" name="åˆ°è²¨æ—¥æœŸ" type="date" class="flex-1 border-gray-300 rounded py-1 px-2 text-sm" />
               <button type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2" data-target="editArrivalDate">ä»Šå¤©</button>
             </div>
             <div class="flex items-center gap-2">
               <span class="text-xs text-gray-500 w-16">å–èµ°æ—¥æœŸ</span>
               <input id="editPickupDate" name="å–èµ°æ—¥æœŸ" type="date" class="flex-1 border-gray-300 rounded py-1 px-2 text-sm" />
               <button type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2" data-target="editPickupDate">ä»Šå¤©</button>
             </div>
           </div>

           <div class="col-span-2">
              <label class="flex items-center gap-2 text-sm p-1">
                <input id="editPaid" name="paid" type="checkbox" value="æ˜¯" class="rounded text-indigo-600 focus:ring-indigo-500" />
                <span>å·²ä»˜æ¸…</span>
              </label>
           </div>
           
           <!-- Multi-date fields (Simplified UI) -->
           <div class="col-span-2 bg-yellow-50 p-2 rounded border border-yellow-100">
              <label class="text-xs font-bold text-gray-500 mb-1 block">æœªæ¥é›»è©±</label>
              <div class="flex gap-1 mb-1">
                <input id="editMissedInput" type="date" class="flex-1 border-gray-300 rounded text-xs px-1" />
                <button id="editAddMissed" type="button" class="btn bg-white border text-xs px-2">+</button>
                <button id="editStampMissed" type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2">ä»Š</button>
              </div>
              <div id="editMissedTags" class="flex flex-wrap gap-1"></div>
              <input type="hidden" id="editMissedHidden" name="æœªæ¥é›»è©±æ—¥æœŸ" />
           </div>

           <div class="col-span-2 bg-blue-50 p-2 rounded border border-blue-100">
              <label class="text-xs font-bold text-gray-500 mb-1 block">é€šçŸ¥æ—¥æœŸ</label>
              <div class="flex gap-1 mb-1">
                <input id="editNotifyInput" type="date" class="flex-1 border-gray-300 rounded text-xs px-1" />
                <button id="editAddNotify" type="button" class="btn bg-white border text-xs px-2">+</button>
                <button id="editStampNotify" type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2">ä»Š</button>
              </div>
              <div id="editNotifyTags" class="flex flex-wrap gap-1"></div>
              <input type="hidden" id="editNotifyHidden" name="é€šçŸ¥æ—¥æœŸ" />
           </div>

           <div class="col-span-2">
             <label class="text-xs text-gray-500 block mb-1">å‚™è¨»</label>
             <textarea id="editNotes" name="å‚™è¨»" rows="2" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm"></textarea>
           </div>
           
           <div class="col-span-2">
             <label class="text-xs text-gray-500 block mb-1">åˆ†åº—èª¿æ’¥</label>
             <input id="editStoreTransfer" name="åˆ†åº—èª¿æ’¥" class="w-full border-gray-300 rounded py-1.5 px-2 text-sm" />
           </div>
        </div>

        <div class="flex justify-between pt-3 border-t mt-2">
          <button type="button" id="deleteEdit" class="btn bg-red-100 text-red-700 hover:bg-red-200 text-xs">åˆªé™¤æ­¤å–®</button>
          <div class="flex gap-2">
            <button type="button" id="cancelEdit" class="btn bg-gray-100 text-gray-700 text-sm">å–æ¶ˆ</button>
            <button type="submit" id="saveEdit" class="btn bg-green-600 text-white hover:bg-green-700 text-sm">å„²å­˜</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Long Term Edit Modal (Simplified same structure) -->
  <div id="longTerm_editModalBackdrop" class="modal-backdrop hidden">
    <div class="modal flex flex-col">
       <div class="flex items-center justify-between mb-3 border-b pb-2">
        <h3 class="text-lg font-bold text-blue-800">ç·¨è¼¯é•·æœŸè¨‚å–®</h3>
        <button id="longTerm_closeEditModal" class="p-2 text-gray-500 text-xl">&times;</button>
      </div>
      <form id="longTerm_editForm" class="flex-1 overflow-y-auto pr-1 space-y-3">
        <input type="hidden" id="longTerm_editRowIndex" name="row" />
        <input type="hidden" id="longTerm_editLongTermHidden" />
        
        <div class="grid grid-cols-2 gap-3">
           <div class="col-span-1"><label class="text-xs text-gray-500 block">å®¢è™Ÿ</label><input id="longTerm_editCustomerID" name="å®¢è™Ÿ" class="w-full border-gray-300 rounded py-1 px-2 text-sm" /></div>
           <div class="col-span-1"><label class="text-xs text-gray-500 block">å§“å</label><input id="longTerm_editCustomerName" name="å§“å" class="w-full border-gray-300 rounded py-1 px-2 text-sm" /></div>
           <div class="col-span-2"><label class="text-xs text-gray-500 block">é›»è©±</label><input id="longTerm_editPhone" name="é€£çµ¡é›»è©±" class="w-full border-gray-300 rounded py-1 px-2 text-sm" /></div>
           
           <div class="col-span-2 bg-gray-50 p-2 rounded">
             <div class="text-xs text-gray-400 mb-1">å•†å“ A</div>
             <div class="grid grid-cols-12 gap-2">
                <div class="col-span-12"><input id="longTerm_editProductAName" name="å®¢è¨‚å•†å“A" class="w-full border-gray-300 rounded text-sm py-1" /></div>
                <div class="col-span-8"><input id="longTerm_editProductASpec" name="Aå•†å“è¦æ ¼" class="w-full border-gray-300 rounded text-sm py-1" /></div>
                <div class="col-span-4"><input id="longTerm_editProductAQty" name="Aæ•¸é‡" class="w-full border-gray-300 rounded text-sm py-1 text-center" /></div>
             </div>
           </div>
           
           <div class="col-span-2 bg-gray-50 p-2 rounded">
             <div class="text-xs text-gray-400 mb-1">å•†å“ B</div>
             <div class="grid grid-cols-12 gap-2">
                <div class="col-span-12"><input id="longTerm_editProductBName" name="å®¢è¨‚å•†å“B" class="w-full border-gray-300 rounded text-sm py-1" /></div>
                <div class="col-span-8"><input id="longTerm_editProductBSpec" name="Bå•†å“è¦æ ¼" class="w-full border-gray-300 rounded text-sm py-1" /></div>
                <div class="col-span-4"><input id="longTerm_editProductBQty" name="Bæ•¸é‡" class="w-full border-gray-300 rounded text-sm py-1 text-center" /></div>
             </div>
           </div>

           <div class="col-span-2"><label class="flex gap-2 text-sm"><input id="longTerm_editPaid" name="paid" type="checkbox" />å·²ä»˜æ¸…</label></div>

           <!-- Multi Dates for Long Term -->
           <div class="col-span-2 space-y-2">
             <div class="bg-gray-50 p-2 rounded">
               <label class="text-xs font-bold text-gray-500 block">æ¡è³¼è¨˜éŒ„</label>
               <div class="flex gap-1 mb-1"><input id="longTerm_editPurchaseInput" type="date" class="flex-1 border-gray-300 text-xs" /><button id="longTerm_editAddPurchase" type="button" class="btn bg-white border text-xs px-2">+</button><button id="longTerm_editStampPurchase" type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2">ä»Š</button></div>
               <div id="longTerm_editPurchaseTags" class="flex flex-wrap gap-1"></div>
               <input type="hidden" id="longTerm_editPurchaseHidden" name="æ¡è³¼æ—¥æœŸ" />
             </div>
             
             <div class="bg-gray-50 p-2 rounded">
               <label class="text-xs font-bold text-gray-500 block">åˆ°è²¨è¨˜éŒ„</label>
               <div class="flex gap-1 mb-1"><input id="longTerm_editArrivalInput" type="date" class="flex-1 border-gray-300 text-xs" /><button id="longTerm_editAddArrival" type="button" class="btn bg-white border text-xs px-2">+</button><button id="longTerm_editStampArrival" type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2">ä»Š</button></div>
               <div id="longTerm_editArrivalTags" class="flex flex-wrap gap-1"></div>
               <input type="hidden" id="longTerm_editArrivalHidden" name="åˆ°è²¨æ—¥æœŸ" />
             </div>

             <div class="bg-gray-50 p-2 rounded">
               <label class="text-xs font-bold text-gray-500 block">å–è²¨è¨˜éŒ„</label>
               <div class="flex gap-1 mb-1"><input id="longTerm_editPickupInput" type="date" class="flex-1 border-gray-300 text-xs" /><button id="longTerm_editAddPickup" type="button" class="btn bg-white border text-xs px-2">+</button><button id="longTerm_editStampPickup" type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2">ä»Š</button></div>
               <div id="longTerm_editPickupTags" class="flex flex-wrap gap-1"></div>
               <input type="hidden" id="longTerm_editPickupHidden" name="å–èµ°æ—¥æœŸ" />
             </div>
             
             <div class="bg-yellow-50 p-2 rounded">
               <label class="text-xs font-bold text-gray-500 block">æœªæ¥é›»è©±</label>
               <div class="flex gap-1 mb-1"><input id="longTerm_editMissedInput" type="date" class="flex-1 border-gray-300 text-xs" /><button id="longTerm_editAddMissed" type="button" class="btn bg-white border text-xs px-2">+</button><button id="longTerm_editStampMissed" type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2">ä»Š</button></div>
               <div id="longTerm_editMissedTags" class="flex flex-wrap gap-1"></div>
               <input type="hidden" id="longTerm_editMissedHidden" name="æœªæ¥é›»è©±æ—¥æœŸ" />
             </div>
             
             <div class="bg-blue-50 p-2 rounded">
               <label class="text-xs font-bold text-gray-500 block">é€šçŸ¥è¨˜éŒ„</label>
               <div class="flex gap-1 mb-1"><input id="longTerm_editNotifyInput" type="date" class="flex-1 border-gray-300 text-xs" /><button id="longTerm_editAddNotify" type="button" class="btn bg-white border text-xs px-2">+</button><button id="longTerm_editStampNotify" type="button" class="btn bg-blue-100 text-blue-700 text-xs px-2">ä»Š</button></div>
               <div id="longTerm_editNotifyTags" class="flex flex-wrap gap-1"></div>
               <input type="hidden" id="longTerm_editNotifyHidden" name="é€šçŸ¥æ—¥æœŸ" />
             </div>
           </div>
           
           <div class="col-span-2"><label class="text-xs text-gray-500 block">å‚™è¨»</label><textarea id="longTerm_editNotes" name="å‚™è¨»" rows="2" class="w-full border-gray-300 rounded text-sm p-1"></textarea></div>
           <div class="col-span-2"><label class="text-xs text-gray-500 block">èª¿æ’¥</label><input id="longTerm_editStoreTransfer" name="åˆ†åº—èª¿æ’¥" class="w-full border-gray-300 rounded text-sm p-1" /></div>
        </div>

        <div class="flex justify-between pt-3 border-t mt-2">
          <button type="button" id="longTerm_deleteEdit" class="btn bg-red-100 text-red-700 text-xs">åˆªé™¤</button>
          <div class="flex gap-2">
            <button type="button" id="longTerm_cancelEdit" class="btn bg-gray-100 text-gray-700 text-sm">å–æ¶ˆ</button>
            <button type="submit" id="longTerm_saveEdit" class="btn bg-green-600 text-white text-sm">å„²å­˜</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Blacklist Add Modal -->
  <div id="blacklist_addModalBackdrop" class="modal-backdrop hidden">
    <div class="modal flex flex-col max-w-md">
      <div class="flex items-center justify-between mb-3 border-b pb-2">
        <h3 class="text-lg font-bold text-red-700">æ–°å¢é»‘åå–®</h3>
        <button id="blacklist_closeAddModal" class="p-2 text-gray-500 text-xl">&times;</button>
      </div>
      <form id="blacklist_addForm" class="space-y-3">
         <div><label class="text-xs text-gray-500">é›»è©± (é¸å¡«)</label><input name="é›»è©±" class="w-full border-gray-300 rounded p-1.5" /></div>
         <div><label class="text-xs text-gray-500">å§“å (é¸å¡«)</label><input name="å§“å" class="w-full border-gray-300 rounded p-1.5" /></div>
         <div><label class="text-xs text-gray-500">å®¢è™Ÿ (é¸å¡«)</label><input name="å®¢è™Ÿ" class="w-full border-gray-300 rounded p-1.5" /></div>
         <div><label class="text-xs text-gray-500">åŸå› </label><input name="åŸå› " class="w-full border-gray-300 rounded p-1.5" /></div>
         <input type="hidden" id="blacklist_addStore" name="åº—åˆ¥" />
         <div class="flex justify-end gap-2 pt-2">
           <button type="button" id="blacklist_cancelAdd" class="btn bg-gray-100">å–æ¶ˆ</button>
           <button type="submit" class="btn bg-red-600 text-white">æ–°å¢</button>
         </div>
      </form>
    </div>
  </div>

  <!-- Blacklist Edit Modal -->
  <div id="blacklist_editModalBackdrop" class="modal-backdrop hidden">
    <div class="modal flex flex-col max-w-md">
      <div class="flex items-center justify-between mb-3 border-b pb-2">
        <h3 class="text-lg font-bold text-red-700">ç·¨è¼¯é»‘åå–®</h3>
        <button id="blacklist_closeEditModal" class="p-2 text-gray-500 text-xl">&times;</button>
      </div>
      <form id="blacklist_editForm" class="space-y-3">
         <input type="hidden" id="blacklist_editRowIndex" name="row" />
         <div><label class="text-xs text-gray-500">é›»è©±</label><input id="bl_edit_phone" name="é›»è©±" class="w-full border-gray-300 rounded p-1.5" /></div>
         <div><label class="text-xs text-gray-500">å§“å</label><input id="bl_edit_name" name="å§“å" class="w-full border-gray-300 rounded p-1.5" /></div>
         <div><label class="text-xs text-gray-500">å®¢è™Ÿ</label><input id="bl_edit_custID" name="å®¢è™Ÿ" class="w-full border-gray-300 rounded p-1.5" /></div>
         <div><label class="text-xs text-gray-500">åŸå› </label><input id="bl_edit_reason" name="åŸå› " class="w-full border-gray-300 rounded p-1.5" /></div>
         <div><label class="text-xs text-gray-500">æ—¥æœŸ</label><input id="bl_edit_date" name="æ—¥æœŸ" type="date" class="w-full border-gray-300 rounded p-1.5" /></div>
         <div><label class="text-xs text-gray-500">å‚™è¨»</label><textarea id="bl_edit_notes" name="å‚™è¨»" class="w-full border-gray-300 rounded p-1.5"></textarea></div>
         <input type="hidden" id="bl_edit_store" name="åº—åˆ¥" />
         
         <div class="flex justify-end gap-2 pt-2">
           <button type="button" id="blacklist_cancelEdit" class="btn bg-gray-100">å–æ¶ˆ</button>
           <button type="submit" class="btn bg-green-600 text-white">å„²å­˜</button>
         </div>
      </form>
    </div>
  </div>

  <script>
    // --- æ ¸å¿ƒé‚è¼¯èˆ‡åŸæœ¬ä¿æŒä¸€è‡´ï¼Œåƒ…é‡å° UI äº‹ä»¶åšç¶å®š ---
    
    // CONSTANTS & DOM Refs
    // è«‹ç¢ºèªæ­¤ URL èˆ‡æ‚¨çš„ Apps Script éƒ¨ç½²ç¶²å€ä¸€è‡´
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfDwaVTkHD-HGtY-6MzxscARnxwML9j1Ejn4v5cvPCAlgIPNRNkuU07r_61OBEVAYK/exec";
    
    // Accordion Logic
    const formToggleBtn = document.getElementById('formToggleBtn');
    const formContent = document.getElementById('formContent');
    const arrowIcon = document.querySelector('.arrow-icon');
    
    formToggleBtn.addEventListener('click', () => {
      const isOpen = formContent.classList.contains('open');
      if (isOpen) {
        formContent.classList.remove('open');
        arrowIcon.classList.remove('open');
      } else {
        formContent.classList.add('open');
        arrowIcon.classList.add('open');
      }
    });

    // é è¨­å±•é–‹æˆ–æ”¶åˆï¼Ÿé€™è£¡è¨­å®šé è¨­æ”¶åˆï¼Œè‹¥æƒ³é è¨­å±•é–‹è«‹åœ¨ HTML class åŠ  open
    
    // ... (ä»¥ä¸‹ç‚ºèˆ‡åŸé‚è¼¯ç›¸åŒçš„ JavaScriptï¼Œé©é…æ–° ID) ...

    const storeSelect = document.getElementById('storeSelect');
    const storeLockCheckbox = document.getElementById('storeLockCheckbox');
    const refreshStoresBtn = document.getElementById('refreshStoresBtn');
    const topMessage = document.getElementById('top-message');
    const messageBox = document.getElementById('message-box');
    const form = document.getElementById('orderForm');
    const submitButton = document.getElementById('submitButton');
    const currentStoreDisplay = document.getElementById('currentStoreDisplay');

    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const refreshButton = document.getElementById('refreshButton');
    const clearOverdueBtn = document.getElementById('clearOverdueBtn');
    const dataMessageBox = document.getElementById('data-message-box');
    const dataLoader = document.getElementById('dataLoader');
    const noDataText = document.getElementById('noDataText');
    const dataTableContainer = document.getElementById('dataTableContainer');
    const dataTableHeaders = document.getElementById('data-table-headers');
    const dataTableBody = document.getElementById('data-table-body');

    const longTerm_searchInput = document.getElementById('longTerm_searchInput');
    const longTerm_searchButton = document.getElementById('longTerm_searchButton');
    const longTerm_refreshButton = document.getElementById('longTerm_refreshButton');
    const longTerm_dataMessageBox = document.getElementById('longTerm_data-message-box');
    const longTerm_dataLoader = document.getElementById('longTerm_dataLoader');
    const longTerm_noDataText = document.getElementById('longTerm_noDataText');
    const longTerm_dataTableContainer = document.getElementById('longTerm_dataTableContainer');
    const longTerm_dataTableHeaders = document.getElementById('longTerm_data-table-headers');
    const longTerm_dataTableBody = document.getElementById('longTerm_data-table-body');

    // Blacklist Refs
    const blacklistAlertBar = document.getElementById('blacklist-alert-bar');
    const blacklistSearchInput = document.getElementById('blacklist_searchInput');
    const blacklistSearchButton = document.getElementById('blacklist_searchButton');
    const blacklistRefreshButton = document.getElementById('blacklist_refreshButton');
    const blacklistDataLoader = document.getElementById('blacklist_dataLoader');
    const blacklistNoDataText = document.getElementById('blacklist_noDataText');
    const blacklistDataTableContainer = document.getElementById('blacklist_dataTableContainer');
    const blacklistDataTableHeaders = document.getElementById('blacklist_data-table-headers');
    const blacklistDataTableBody = document.getElementById('blacklist_data-table-body');
    const blacklistAddButton = document.getElementById('blacklist_addButton');
    const blacklistAddModalBackdrop = document.getElementById('blacklist_addModalBackdrop');
    const blacklistCloseAddModal = document.getElementById('blacklist_closeAddModal');
    const blacklistCancelAdd = document.getElementById('blacklist_cancelAdd');
    const blacklistAddForm = document.getElementById('blacklist_addForm');
    const blacklistAddStoreInput = document.getElementById('blacklist_addStore');

    const statusTabsEl = document.getElementById('statusTabs');
    const ltStatusTabsEl = document.getElementById('ltStatusTabs');

    // Edit Modals
    const editModalBackdrop = document.getElementById('editModalBackdrop');
    const closeEditModal = document.getElementById('closeEditModal');
    const cancelEdit = document.getElementById('cancelEdit');
    const editForm = document.getElementById('editForm');
    const deleteEditBtn = document.getElementById('deleteEdit');
    
    const longTerm_editModalBackdrop = document.getElementById('longTerm_editModalBackdrop');
    const longTerm_closeEditModal = document.getElementById('longTerm_closeEditModal');
    const longTerm_cancelEdit = document.getElementById('longTerm_cancelEdit');
    const longTerm_deleteEditBtn = document.getElementById('longTerm_deleteEdit');
    const longTerm_editForm = document.getElementById('longTerm_editForm');

    // Tag Controls (Simplified for UI, logic remains)
    const editAddMissed = document.getElementById('editAddMissed');
    const editStampMissed = document.getElementById('editStampMissed');
    const editMissedInput = document.getElementById('editMissedInput');
    const editMissedTags = document.getElementById('editMissedTags');
    const editMissedHidden = document.getElementById('editMissedHidden');

    const editAddNotify = document.getElementById('editAddNotify');
    const editStampNotify = document.getElementById('editStampNotify');
    const editNotifyInput = document.getElementById('editNotifyInput');
    const editNotifyTags = document.getElementById('editNotifyTags');
    const editNotifyHidden = document.getElementById('editNotifyHidden');

    const longTerm_editPurchaseCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddPurchase'),
      stampBtn: document.getElementById('longTerm_editStampPurchase'),
      inputEl: document.getElementById('longTerm_editPurchaseInput'),
      tagsContainer: document.getElementById('longTerm_editPurchaseTags'),
      hiddenInput: document.getElementById('longTerm_editPurchaseHidden')
    };
    const longTerm_editArrivalCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddArrival'),
      stampBtn: document.getElementById('longTerm_editStampArrival'),
      inputEl: document.getElementById('longTerm_editArrivalInput'),
      tagsContainer: document.getElementById('longTerm_editArrivalTags'),
      hiddenInput: document.getElementById('longTerm_editArrivalHidden')
    };
    const longTerm_editPickupCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddPickup'),
      stampBtn: document.getElementById('longTerm_editStampPickup'),
      inputEl: document.getElementById('longTerm_editPickupInput'),
      tagsContainer: document.getElementById('longTerm_editPickupTags'),
      hiddenInput: document.getElementById('longTerm_editPickupHidden')
    };
    const longTerm_editMissedCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddMissed'),
      stampBtn: document.getElementById('longTerm_editStampMissed'),
      inputEl: document.getElementById('longTerm_editMissedInput'),
      tagsContainer: document.getElementById('longTerm_editMissedTags'),
      hiddenInput: document.getElementById('longTerm_editMissedHidden')
    };
    const longTerm_editNotifyCtrl_el = {
      addBtn: document.getElementById('longTerm_editAddNotify'),
      stampBtn: document.getElementById('longTerm_editStampNotify'),
      inputEl: document.getElementById('longTerm_editNotifyInput'),
      tagsContainer: document.getElementById('longTerm_editNotifyTags'),
      hiddenInput: document.getElementById('longTerm_editNotifyHidden')
    };

    // --- Helpers ---
    function closeModal(){ editModalBackdrop.classList.add('hidden'); }
    function longTerm_closeModal(){ longTerm_editModalBackdrop.classList.add('hidden'); }
    function closeBlacklistAddModal() { blacklistAddModalBackdrop.classList.add('hidden'); }
    function openBlacklistAddModal() {
      const storeText = storeSelect.options[storeSelect.selectedIndex]?.text || '';
      const parts = storeText.split('â€”');
      const storeName = parts.length > 1 ? parts[1].trim() : storeText.trim();
      blacklistAddStoreInput.value = storeName.replace(/^--.*--$/, ''); 
      blacklistAddModalBackdrop.classList.remove('hidden');
    }

    function pad(n){ return String(n).padStart(2,'0'); }
    function todayLocalForInput() { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function todayLocalForSheet() { const d=new Date(); return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`; }
    function digitsOnly(s){ return String(s||'').replace(/\D/g,''); }
    function cleanPhone(p) { return String(p || '').replace(/\D/g, ''); }

    function showTopMessage(txt, isError=false){
      if(!txt){ topMessage.classList.add('hidden'); topMessage.textContent=''; return; }
      topMessage.textContent = txt;
      topMessage.classList.remove('hidden');
      topMessage.style.color = isError ? '#b91c1c' : '#047857';
    }

    function showMessage(type, html){
      if(!messageBox){ console.error(html); return; }
      messageBox.innerHTML = html;
      messageBox.className = 'mt-2 w-full text-center text-sm p-2 rounded';
      if(type === 'success') messageBox.classList.add('bg-green-100','text-green-800');
      else messageBox.classList.add('bg-red-100','text-red-800');
      messageBox.classList.remove('hidden');
    }
    function hideMessage(){ if(messageBox) messageBox.classList.add('hidden'); }

    function showDataMessage(type, html, isLongTerm=false){
      const box = isLongTerm ? longTerm_dataMessageBox : dataMessageBox;
      if(!box) return;
      box.innerHTML = html;
      box.className = 'p-2 mb-2 rounded text-sm text-center';
      if(type === 'error') box.classList.add('bg-red-100','text-red-800');
      else if(type === 'info') box.classList.add('bg-blue-50','text-blue-800');
      else box.classList.add('bg-gray-100','text-gray-800');
      box.classList.remove('hidden');
    }
    function hideDataMessage(isLongTerm=false){
      const box = isLongTerm ? longTerm_dataMessageBox : dataMessageBox;
      if(box) box.classList.add('hidden');
    }

    // --- Data Variables ---
    let allOrders = [];
    let allLongTermOrders = [];
    let allBlacklistData = [];
    let tableHeadersOriginal = []; 
    let longTerm_tableHeadersOriginal = [];
    
    let currentStatusFilter = 'all';
    let currentLTStatusFilter = 'all';
    
    let headerNameMap = {
      'å®¢è¨‚å•†å“A':'å“åA','Aå•†å“è¦æ ¼':'è¦æ ¼A',
      'å®¢è¨‚å•†å“B':'å“åB','Bå•†å“è¦æ ¼':'è¦æ ¼B',
      'Aæ•¸é‡':'æ•¸A', 'Bæ•¸é‡':'æ•¸B',
      'å›ºå®š/é•·æœŸå®¢è¨‚': 'é•·æœŸ', 'paid': 'ä»˜æ¸…',
      'é€£çµ¡é›»è©±': 'é›»è©±', 'LINEåç¨±': 'LINE'
    };

    function getOrderStatus(order){
      const purchaseDate = order['æ¡è³¼æ—¥æœŸ'];
      const arrivalDate = order['åˆ°è²¨æ—¥æœŸ'];
      const missedCallDates = order['æœªæ¥é›»è©±æ—¥æœŸ'];
      const notifyDates = order['é€šçŸ¥æ—¥æœŸ'];
      const pickupDate = order['å–èµ°æ—¥æœŸ'];
      if (pickupDate && String(pickupDate).trim()) return { text:'å·²å–è²¨', class:'status-closed' };
      if (notifyDates && String(notifyDates).trim()) return { text:'å·²é€šçŸ¥', class:'status-notified' };
      if (missedCallDates && String(missedCallDates).trim()) return { text:'æœªæ¥', class:'status-missed' };
      if (arrivalDate && String(arrivalDate).trim()) return { text:'å·²åˆ°è²¨', class:'status-arrived' };
      if (purchaseDate && String(purchaseDate).trim()) return { text:'å·²æ¡è³¼', class:'status-purchase' };
      return { text:'æœªè™•ç†', class:'status-pending' };
    }
    
    function pawSVG(){ return `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234b5563'%3E%3Cpath d='M19.5 10.5c0 1.38-1.12 2.5-2.5 2.5s-2.5-1.12-2.5-2.5S15.62 8 17 8s2.5 1.12 2.5 2.5zM11.5 6c0 1.38-1.12 2.5-2.5 2.5S6.5 7.38 6.5 6 7.62 3.5 9 3.5 11.5 4.62 11.5 6zM6 13.5c0 1.38-1.12 2.5-2.5 2.5S1 14.88 1 13.5 2.12 11 3.5 11 6 12.12 6 13.5zM21 13.5c0 1.38-1.12 2.5-2.5 2.5S16 14.88 16 13.5 17.12 11 18.5 11 21 12.12 21 13.5zM12 12c-2 0-4 2-4 4 0 2 1.79 4 4 4s4-2 4-4c0-2-2-4-4-4z'/%3E%3C/svg%3E" class="status-paw" />`; }

    function formatPhone(rawVal){
      if(rawVal===undefined || rawVal===null) return '';
      const s = String(rawVal).trim();
      if(s.startsWith('0')) return s;
      if(/^\d{9}$/.test(s)) return '0'+s;
      return s;
    }

    function isChecked(value) {
        if (typeof value === 'boolean') return value;
        if (typeof value === 'string') {
            const s = value.toLowerCase().trim();
            return s === 'æ˜¯' || s === 'true' || s === '1' || s === 'yes';
        }
        return false;
    }

    function formatFieldValueIfDate(fieldName, rawValue){
      if(!rawValue && rawValue !== 0) return '';
      const DATE_FIELDS = ['æ¡è³¼æ—¥æœŸ','åˆ°è²¨æ—¥æœŸ','å–èµ°æ—¥æœŸ','æœªæ¥é›»è©±æ—¥æœŸ','é€šçŸ¥æ—¥æœŸ','å»ºç«‹æ—¥æœŸ','creationDate','æœ€å¾Œæ›´æ–°æ™‚é–“'];
      if(DATE_FIELDS.includes(fieldName)){
        const parts = String(rawValue).split(/[,;ï¼Œ\n]+/).map(s=>s.trim()).filter(Boolean).map(formatToYYYYMMDD);
        // æ‰‹æ©Ÿç‰ˆåƒ…é¡¯ç¤ºæœ€æ–°ä¸€å€‹æ—¥æœŸä»¥ç¯€çœç©ºé–“
        if(parts.length > 1) return parts[parts.length-1] + `(${parts.length})`; 
        return parts.join(', ');
      }
      if(String(rawValue).includes('T') || /\d{4}-\d{2}-\d{2}/.test(String(rawValue))) return formatToYYYYMMDD(rawValue);
      return String(rawValue);
    }

    function formatToYYYYMMDD(singleVal){
      if(!singleVal && singleVal !== 0) return '';
      const s = String(singleVal).trim();
      const m1 = s.match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})$/);
      if(m1) return `${m1[2]}/${m1[3]}`; // ç°¡åŒ–ï¼šåªé¡¯ç¤º æœˆ/æ—¥
      const isoLike = s.match(/\d{4}-\d{2}-\d{2}/);
      if(isoLike){
        const parsed = new Date(s);
        if(!isNaN(parsed)){ return `${pad(parsed.getMonth()+1)}/${pad(parsed.getDate())}`; }
      }
      return s;
    }

    function toDateOnly(val) {
      if (!val && val !== 0) return '';
      const s = String(val).trim();
      const m1 = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
      if (m1) {
        return `${m1[1]}-${String(m1[2]).padStart(2,'0')}-${String(m1[3]).padStart(2,'0')}`;
      }
      return '';
    }
    function parseMultiDateStringToArray(dateString) {
        if (!dateString || typeof dateString !== 'string') return [];
        return dateString.split(/[,;ï¼Œ\s]+/).map(s => toDateOnly(s)).filter(Boolean);
    }
    function getOrderTimestamp(order){
      if(order && order.creationDate) return Date.parse(order.creationDate);
      return 0;
    }

    function renderTableHeaders(displayHeaders){
      dataTableHeaders.innerHTML = '';
      const headers = ['ç‹€æ…‹', ...displayHeaders];
      headers.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h;
        dataTableHeaders.appendChild(th);
      });
    }

    function renderLongTermTableHeaders(displayHeaders){
      longTerm_dataTableHeaders.innerHTML = '';
      const headers = ['ç‹€æ…‹', ...displayHeaders];
      headers.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h;
        longTerm_dataTableHeaders.appendChild(th);
      });
    }

    function renderBlacklistTable(data, headers) {
      blacklistDataTableHeaders.innerHTML = '';
      blacklistDataTableBody.innerHTML = '';
      if (!data || data.length === 0) {
        blacklistNoDataText.classList.remove('hidden');
        blacklistDataTableContainer.classList.add('hidden');
        return;
      }
      blacklistDataTableContainer.classList.remove('hidden');
      const opsTh = document.createElement('th');
      opsTh.textContent = 'æ“ä½œ';
      blacklistDataTableHeaders.appendChild(opsTh);
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        blacklistDataTableHeaders.appendChild(th);
      });

      data.forEach(row => {
        const tr = document.createElement('tr');
        const opsTd = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.className = 'text-blue-600 hover:text-blue-800 font-bold px-1';
        editBtn.textContent = 'ç·¨';
        editBtn.onclick = () => openBlacklistEditModal(row);
        opsTd.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'text-red-600 hover:text-red-800 font-bold px-1 ml-1';
        delBtn.textContent = 'åˆª';
        delBtn.onclick = () => deleteBlacklistRow(row['__row']);
        opsTd.appendChild(delBtn);

        tr.appendChild(opsTd);
        headers.forEach(h => {
          const td = document.createElement('td');
          let val = row[h];
          if (val && (h.includes('æ—¥æœŸ') || h.includes('Date'))) val = formatFieldValueIfDate(h, val);
          td.textContent = val || '';
          tr.appendChild(td);
        });
        blacklistDataTableBody.appendChild(tr);
      });
    }

    function displayData(orders){
      dataTableBody.innerHTML = '';
      if(!orders || orders.length === 0){
        noDataText.classList.remove('hidden');
        dataTableContainer.classList.add('hidden');
        noDataText.textContent = 'ç„¡è³‡æ–™';
        return;
      }
      noDataText.classList.add('hidden');
      dataTableContainer.classList.remove('hidden');

      orders.forEach(order=>{
        const tr = document.createElement('tr'); 
        tr.className = 'cursor-pointer hover:bg-blue-50'; // æ•´è¡Œå¯é»æ“Š
        
        // é»æ“Šæ•´è¡Œé–‹å•Ÿç·¨è¼¯
        tr.onclick = (e) => {
            // å¦‚æœé»åˆ°æŒ‰éˆ•å°±ä¸è§¸ç™¼æ•´è¡Œäº‹ä»¶
            if(e.target.tagName === 'BUTTON' || e.target.parentElement.tagName === 'BUTTON') return;
            openEditModal(order['__row']);
        };

        const status = getOrderStatus(order);
        const statusTd = document.createElement('td');
        statusTd.innerHTML = `<span class="status-tag ${status.class}">${status.text}</span>`;
        tr.appendChild(statusTd);

        tableHeadersOriginal.forEach(origHeader=>{
          const td = document.createElement('td');
          const rawVal = (order[origHeader] !== undefined && order[origHeader] !== null) ? order[origHeader] : '';
          const isCustomerIdField = /å®¢è™Ÿ|cust ?id/i.test(origHeader);

          if (isCustomerIdField) {
            td.textContent = String(rawVal);
          } else if (origHeader === 'paid' || origHeader === 'ä»˜æ¸…' || origHeader === 'å›ºå®š/é•·æœŸå®¢è¨‚') {
            td.textContent = isChecked(rawVal) ? 'âœ”' : '';
             if(isChecked(rawVal)) td.style.color = '#059669';
          } else if(origHeader.includes('é›»è©±')){
            td.textContent = formatPhone(rawVal);
          } else {
            td.textContent = formatFieldValueIfDate(origHeader, rawVal);
          }
          tr.appendChild(td);
        });
        dataTableBody.appendChild(tr);
      });
    }

    function displayLongTermData(orders){
      longTerm_dataTableBody.innerHTML = '';
      if(!orders || orders.length === 0){
        longTerm_noDataText.classList.remove('hidden');
        longTerm_dataTableContainer.classList.add('hidden');
        return;
      }
      longTerm_noDataText.classList.add('hidden');
      longTerm_dataTableContainer.classList.remove('hidden');

      orders.forEach(order=>{
        const tr = document.createElement('tr');
        tr.className = 'cursor-pointer hover:bg-blue-50';
        tr.onclick = (e) => {
            if(e.target.tagName === 'BUTTON') return;
            openLongTermEditModal(order['__row']);
        };
        
        const status = getOrderStatus(order);
        const statusTd = document.createElement('td');
        statusTd.innerHTML = `<span class="status-tag ${status.class}">${status.text}</span>`;
        tr.appendChild(statusTd);

        longTerm_tableHeadersOriginal.forEach(origHeader=>{
          const td = document.createElement('td');
          const rawVal = order[origHeader] || '';
          const isCustomerIdField = /å®¢è™Ÿ|cust ?id/i.test(origHeader);

          if (isCustomerIdField) {
            td.textContent = String(rawVal);
          } else if (origHeader === 'paid' || origHeader === 'ä»˜æ¸…' || origHeader === 'å›ºå®š/é•·æœŸå®¢è¨‚') {
            td.textContent = isChecked(rawVal) ? 'âœ”' : '';
          } else if(origHeader.includes('é›»è©±')){
            td.textContent = formatPhone(rawVal);
          } else {
            td.textContent = formatFieldValueIfDate(origHeader, rawVal);
          }
          tr.appendChild(td);
        });
        longTerm_dataTableBody.appendChild(tr);
      });
    }

    function renderStatusTabs(containerEl, currentKey, onChange){
      containerEl.innerHTML = '';
      const STATUS_KEYS = [
        { key: 'all', label: 'å…¨éƒ¨' },
        { key: 'æœªè™•ç†', label: 'æœªè™•ç†' },
        { key: 'å·²æ¡è³¼', label: 'å·²æ¡è³¼' },
        { key: 'å·²åˆ°è²¨', label: 'å·²åˆ°è²¨' },
        { key: 'æœªæ¥', label: 'æœªæ¥' },
        { key: 'å·²é€šçŸ¥', label: 'å·²é€šçŸ¥' },
        { key: 'å·²å–è²¨', label: 'å·²å–è²¨' }
      ];
      STATUS_KEYS.forEach(s=>{
        const btn = document.createElement('div');
        btn.className = 'status-tab' + (s.key === currentKey ? ' active' : '');
        if(s.key === 'all') btn.classList.add('all');
        btn.textContent = s.label;
        btn.addEventListener('click', ()=>{ onChange(s.key); });
        containerEl.appendChild(btn);
      });
    }

    // --- Filter Functions ---
    function filterAndDisplayData(){
      const term = (searchInput.value || '').toLowerCase().trim();
      const searchDigits = digitsOnly(term);
      let filtered = allOrders.slice();
      if(currentStatusFilter && currentStatusFilter !== 'all'){
        filtered = filtered.filter(order => {
          const st = getOrderStatus(order).text;
          return st === currentStatusFilter;
        });
      }
      if(!term){ hideDataMessage(); displayData(filtered); return; }
      const result = filtered.filter(order=>{
        return Object.values(order).some(val => String(val).toLowerCase().includes(term));
      });
      if(result.length === 0){ displayData([]); showDataMessage('info', 'æ‰¾ä¸åˆ°è³‡æ–™'); }
      else { hideDataMessage(); displayData(result); }
    }

    function filterAndDisplayLongTermData(){
      const term = (longTerm_searchInput.value || '').toLowerCase().trim();
      let filtered = allLongTermOrders.slice();
      if(currentLTStatusFilter && currentLTStatusFilter !== 'all'){
        filtered = filtered.filter(order => {
          const st = getOrderStatus(order).text;
          return st === currentLTStatusFilter;
        });
      }
      if(!term){ hideDataMessage(true); displayLongTermData(filtered); return; }
      const result = filtered.filter(order=>{
        return Object.values(order).some(val => String(val).toLowerCase().includes(term));
      });
      if(result.length === 0){ displayLongTermData([]); showDataMessage('info', 'æ‰¾ä¸åˆ°è³‡æ–™', true); }
      else { hideDataMessage(true); displayLongTermData(result); }
    }
    
    function filterBlacklist() {
      const term = (blacklistSearchInput.value || '').toLowerCase().trim();
      if (!term) { fetchBlacklistData(); return; }
      const filtered = allBlacklistData.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(term)));
      renderBlacklistTable(filtered, ['å®¢è™Ÿ','å§“å','é›»è©±','åŸå› ']); // ç°¡åŒ–æ¬„ä½
    }

    function setMainStatusFilter(key){
      currentStatusFilter = key;
      renderStatusTabs(statusTabsEl, currentStatusFilter, setMainStatusFilter);
      filterAndDisplayData();
    }
    function setLTStatusFilter(key){
      currentLTStatusFilter = key;
      renderStatusTabs(ltStatusTabsEl, currentLTStatusFilter, setLTStatusFilter);
      filterAndDisplayLongTermData();
    }

    // --- API Calls ---
    async function fetchBlacklistData() {
      blacklistDataLoader.classList.remove('hidden');
      blacklistDataTableContainer.classList.add('hidden');
      try {
        const resp = await fetch(`${SCRIPT_URL}?action=blacklist`);
        const json = await resp.json();
        if (json.result === 'success') {
          allBlacklistData = json.rows || [];
          renderBlacklistTable(allBlacklistData, ['å®¢è™Ÿ','å§“å','é›»è©±','åŸå› ','æ—¥æœŸ']); 
        } else {
          blacklistNoDataText.classList.remove('hidden');
        }
      } catch (e) { console.error(e); } finally { blacklistDataLoader.classList.add('hidden'); }
    }

    async function deleteRow(rowValue, btnElement){
      if(!rowValue) return;
      if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
      const store = storeSelect.value || '';
      try {
        const fd = new FormData();
        fd.append('action', 'delete');
        fd.append('row', rowValue);
        if(store) fd.append('store', store);
        const resp = await fetch(SCRIPT_URL, { method:'POST', body: fd });
        const json = await resp.json();
        if(json.result === 'success'){
          closeModal(); longTerm_closeModal();
          fetchOrderData();
        } else { alert('åˆªé™¤å¤±æ•—'); }
      } catch(err){ alert('éŒ¯èª¤: '+err.message); }
    }
    
    // éœé»˜åˆªé™¤ (ç”¨æ–¼æ‰¹æ¬¡)
    async function deleteRowSilent(rowValue) {
      const store = storeSelect.value || '';
      const fd = new FormData(); fd.append('action', 'delete'); fd.append('row', rowValue); if(store) fd.append('store', store);
      const resp = await fetch(SCRIPT_URL, { method:'POST', body: fd });
      const json = await resp.json();
      if(json.result !== 'success') throw new Error(json.error);
    }

    async function fetchStores(){
      showTopMessage('è®€å–ä¸­...');
      try{
        const resp = await fetch(`${SCRIPT_URL}?action=stores`);
        const json = await resp.json();
        let stores = json.stores || [];
        populateStoreSelect(stores);
        showTopMessage('', false);
      }catch(err){ showTopMessage('è®€å–åˆ†åº—å¤±æ•—', true); }
    }

    function populateStoreSelect(stores){
      const prev = localStorage.getItem('selected_store');
      storeSelect.innerHTML = '';
      const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'é¸æ“‡åº—åˆ¥'; storeSelect.appendChild(opt);
      stores.forEach(s => {
        // éæ¿¾æ‰æ¨™é¡Œåˆ— (åº—ç·¨è™Ÿã€åº—åã€åº—åç¨±ç­‰)
        if (s.code === 'åº—ç·¨è™Ÿ' || s.name === 'åº—å' || s.name === 'åº—åç¨±') return;
        
        const o = document.createElement('option');
        o.value = s.code; o.textContent = s.name ? `${s.name}` : s.code;
        storeSelect.appendChild(o);
      });
      if(prev) { const found = Array.from(storeSelect.options).some(o => o.value === prev); if(found) storeSelect.value = prev; }
      updateStoreLockUI();
      if (storeSelect.options[storeSelect.selectedIndex]) {
          currentStoreDisplay.textContent = storeSelect.options[storeSelect.selectedIndex].text;
      }
    }

    async function refreshStoresAndCreateMissing(){
      showTopMessage('æª¢æŸ¥åˆ†åº—...');
      try{
        const fd = new FormData(); fd.append('action','create_store_sheets');
        await fetch(SCRIPT_URL, { method:'POST', body: fd });
        fetchStores();
      }catch(err){ showTopMessage('å¤±æ•—', true); }
    }

    async function getStoreLockValue(store){
      if(!store) return false;
      try{
        const resp = await fetch(`${SCRIPT_URL}?action=get_store_lock&store=${encodeURIComponent(store)}`);
        const json = await resp.json();
        return json.locked === '1';
      }catch(e){ return false; }
    }

    async function setStoreLockValue(store, locked){
      try{
        const fd = new FormData(); fd.append('action','set_store_lock'); fd.append('store', store); fd.append('locked', locked ? '1' : '0');
        const resp = await fetch(SCRIPT_URL, { method:'POST', body: fd });
        return (await resp.json()).result === 'success';
      }catch(e){ return false; }
    }

    async function updateStoreLockUI(){
      const store = storeSelect.value;
      if(!store){ storeLockCheckbox.disabled = true; storeSelect.disabled = false; return; }
      storeLockCheckbox.disabled = false;
      const locked = await getStoreLockValue(store);
      storeLockCheckbox.checked = locked;
      storeSelect.disabled = locked;
      if(locked) storeSelect.classList.add('bg-gray-100'); else storeSelect.classList.remove('bg-gray-100');
    }

    async function fetchOrderData(){
      dataLoader.classList.remove('hidden'); longTerm_dataLoader.classList.remove('hidden');
      dataTableContainer.classList.add('hidden'); longTerm_dataTableContainer.classList.add('hidden');
      noDataText.classList.add('hidden'); longTerm_noDataText.classList.add('hidden');
      const store = storeSelect.value || '';
      try{
        const url = store ? `${SCRIPT_URL}?store=${encodeURIComponent(store)}` : SCRIPT_URL;
        const resp = await fetch(url);
        const data = await resp.json();
        const allData = data.rows || [];
        tableHeadersOriginal = data.headers || [];
        longTerm_tableHeadersOriginal = [...tableHeadersOriginal];

        allOrders = []; allLongTermOrders = [];
        allData.forEach(order=>{
          if(isChecked(order['å›ºå®š/é•·æœŸå®¢è¨‚'])) allLongTermOrders.push(order);
          else allOrders.push(order);
        });

        // Sort by Time desc
        const sorter = (a,b) => getOrderTimestamp(b) - getOrderTimestamp(a);
        allOrders.sort(sorter);
        allLongTermOrders.sort(sorter);

        renderStatusTabs(statusTabsEl, currentStatusFilter, setMainStatusFilter);
        renderStatusTabs(ltStatusTabsEl, currentLTStatusFilter, setLTStatusFilter);

        const displayHeaders = tableHeadersOriginal.map(h => headerNameMap[h] || h);
        renderTableHeaders(displayHeaders);
        renderLongTermTableHeaders(displayHeaders);

        filterAndDisplayData();
        filterAndDisplayLongTermData();
      }catch(err){ console.error(err); }finally{
        dataLoader.classList.add('hidden'); longTerm_dataLoader.classList.add('hidden');
      }
    }

    function setupTagControls(addBtn, stampBtn, inputEl, tagsContainer, hiddenInput){
      let items = [];
      const render = () => {
        tagsContainer.innerHTML = '';
        items.forEach(d => {
           const span = document.createElement('span');
           span.className = 'tag';
           span.innerHTML = `${d}<span class="remove" data-date="${d}">&times;</span>`;
           tagsContainer.appendChild(span);
        });
        hiddenInput.value = items.join(', ');
      };
      addBtn && addBtn.addEventListener('click', ()=>{
        if(inputEl.value && !items.includes(inputEl.value)){ items.push(inputEl.value); items.sort(); inputEl.value=''; render(); }
      });
      stampBtn && stampBtn.addEventListener('click', ()=>{
        const v = todayLocalForInput(); if(!items.includes(v)){ items.push(v); items.sort(); render(); }
      });
      tagsContainer.addEventListener('click', (e)=>{
        if(e.target.classList.contains('remove')){ items = items.filter(x=>x!==e.target.dataset.date); render(); }
      });
      return { setItems(arr){ items = (arr||[]).filter(Boolean); items.sort(); render(); }, getItems(){ return items; } };
    }

    const editMissedCtrl = setupTagControls(editAddMissed, editStampMissed, editMissedInput, editMissedTags, editMissedHidden);
    const editNotifyCtrl = setupTagControls(editAddNotify, editStampNotify, editNotifyInput, editNotifyTags, editNotifyHidden);

    const longTerm_editPurchaseCtrl = setupTagControls(longTerm_editPurchaseCtrl_el.addBtn, longTerm_editPurchaseCtrl_el.stampBtn, longTerm_editPurchaseCtrl_el.inputEl, longTerm_editPurchaseCtrl_el.tagsContainer, longTerm_editPurchaseCtrl_el.hiddenInput);
    const longTerm_editArrivalCtrl = setupTagControls(longTerm_editArrivalCtrl_el.addBtn, longTerm_editArrivalCtrl_el.stampBtn, longTerm_editArrivalCtrl_el.inputEl, longTerm_editArrivalCtrl_el.tagsContainer, longTerm_editArrivalCtrl_el.hiddenInput);
    const longTerm_editPickupCtrl = setupTagControls(longTerm_editPickupCtrl_el.addBtn, longTerm_editPickupCtrl_el.stampBtn, longTerm_editPickupCtrl_el.inputEl, longTerm_editPickupCtrl_el.tagsContainer, longTerm_editPickupCtrl_el.hiddenInput);
    const longTerm_editMissedCtrl = setupTagControls(longTerm_editMissedCtrl_el.addBtn, longTerm_editMissedCtrl_el.stampBtn, longTerm_editMissedCtrl_el.inputEl, longTerm_editMissedCtrl_el.tagsContainer, longTerm_editMissedCtrl_el.hiddenInput);
    const longTerm_editNotifyCtrl = setupTagControls(longTerm_editNotifyCtrl_el.addBtn, longTerm_editNotifyCtrl_el.stampBtn, longTerm_editNotifyCtrl_el.inputEl, longTerm_editNotifyCtrl_el.tagsContainer, longTerm_editNotifyCtrl_el.hiddenInput);

    // --- Event Listeners ---
    const phoneInput = document.getElementById('phone');
    const phoneWarning = document.getElementById('phone-warning');
    phoneInput.addEventListener('input', function() {
      const inputVal = this.value.trim().replace(/\D/g, '');
      const inputNoZero = inputVal.replace(/^0+/, '');
      phoneWarning.classList.add('hidden'); phoneWarning.textContent = '';
      if (inputNoZero.length < 6) return;
      const found = allBlacklistData.find(row => {
        const rPhone = String(row['é›»è©±']||row['é€£çµ¡é›»è©±']||'').replace(/\D/g, '').replace(/^0+/, '');
        return rPhone && rPhone === inputNoZero;
      });
      if (found) {
           phoneWarning.textContent = `âš ï¸ é»‘åå–®! åŸå› : ${found['åŸå› ']||''} (${found['å§“å']||''})`;
           phoneWarning.classList.remove('hidden');
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const store = storeSelect.value;
      if (!store) { alert('è«‹é¸åº—åˆ¥'); return; }
      submitButton.disabled = true; submitButton.textContent = '...';
      try {
        const fd = new FormData(form); fd.append('action', 'append'); fd.append('store', store);
        const resp = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
        const json = await resp.json();
        if (json.result === 'success') {
          showMessage('success', 'æˆåŠŸ'); form.reset(); fetchOrderData();
        } else throw new Error(json.error);
      } catch (err) { showMessage('error', err.message); } finally {
        submitButton.disabled = false; submitButton.textContent = 'é€å‡ºè¨‚å–®';
      }
    });

    storeSelect.addEventListener('change', async ()=>{ 
      const store = storeSelect.value;
      if(store) localStorage.setItem('selected_store', store);
      await updateStoreLockUI(); fetchOrderData();
      if (storeSelect.options[storeSelect.selectedIndex]) currentStoreDisplay.textContent = storeSelect.options[storeSelect.selectedIndex].text;
    });

    storeLockCheckbox.addEventListener('change', async ()=> {
      const store = storeSelect.value;
      if(!store){ storeLockCheckbox.checked = false; return; }
      const ok = await setStoreLockValue(store, storeLockCheckbox.checked);
      if(ok) updateStoreLockUI(); else storeLockCheckbox.checked = !storeLockCheckbox.checked;
    });

    refreshStoresBtn.addEventListener('click', refreshStoresAndCreateMissing);
    searchButton.addEventListener('click', filterAndDisplayData);
    refreshButton.addEventListener('click', ()=>{ searchInput.value=''; fetchOrderData(); });

    longTerm_searchButton.addEventListener('click', filterAndDisplayLongTermData);
    longTerm_refreshButton.addEventListener('click', ()=>{ longTerm_searchInput.value=''; fetchOrderData(); });

    if (clearOverdueBtn) {
      clearOverdueBtn.addEventListener('click', async () => {
        if (!confirm(`ç¢ºå®šåˆªé™¤é€¾æœŸ5å¤©ä»¥ä¸Šå·²å–èµ°çš„è³‡æ–™?`)) return;
        clearOverdueBtn.disabled = true; clearOverdueBtn.textContent = '...';
        // Logic similar to original but simplified for length
        const now = new Date();
        const toDelete = allOrders.filter(o => {
           const pStr = o['å–èµ°æ—¥æœŸ']; if(!pStr) return false;
           const pDate = new Date(parseMultiDateStringToArray(pStr)[0]);
           return !isNaN(pDate) && (now - pDate) > (5 * 86400000);
        }).sort((a,b)=>b['__row']-a['__row']);
        
        for(let item of toDelete) await deleteRowSilent(item['__row']);
        alert(`å·²åˆªé™¤ ${toDelete.length} ç­†`);
        clearOverdueBtn.disabled = false; clearOverdueBtn.textContent = 'æ¸…é™¤é€¾æœŸ';
        fetchOrderData();
      });
    }

    // Modal Edit Submits
    [editForm, longTerm_editForm].forEach(f => {
       f.addEventListener('submit', async(e)=>{
         e.preventDefault();
         const store = storeSelect.value;
         const btn = e.target.querySelector('button[type="submit"]');
         btn.disabled=true; btn.textContent='...';
         try{
           const fd = new FormData(f); fd.append('action','update'); fd.append('store', store);
           const resp = await fetch(SCRIPT_URL, {method:'POST', body:fd});
           if((await resp.json()).result==='success'){ closeModal(); longTerm_closeModal(); fetchOrderData(); }
           else alert('å¤±æ•—');
         }catch(er){console.error(er);}finally{ btn.disabled=false; btn.textContent='å„²å­˜'; }
       });
    });
    
    document.getElementById('deleteEdit').addEventListener('click', ()=>{
        deleteRow(document.getElementById('editRowIndex').value);
    });
    document.getElementById('longTerm_deleteEdit').addEventListener('click', ()=>{
        deleteRow(document.getElementById('longTerm_editRowIndex').value);
    });
    
    // Blacklist Modal Logic
    const blEditModal = document.getElementById('blacklist_editModalBackdrop');
    const blEditForm = document.getElementById('blacklist_editForm');
    document.getElementById('blacklist_closeEditModal').addEventListener('click', () => blEditModal.classList.add('hidden'));
    document.getElementById('blacklist_cancelEdit').addEventListener('click', () => blEditModal.classList.add('hidden'));

    function openBlacklistEditModal(row) {
      document.getElementById('blacklist_editRowIndex').value = row['__row'];
      document.getElementById('bl_edit_custID').value = row['å®¢è™Ÿ'] || '';
      document.getElementById('bl_edit_name').value = row['å§“å'] || '';
      document.getElementById('bl_edit_phone').value = row['é›»è©±'] || row['é€£çµ¡é›»è©±'] || '';
      document.getElementById('bl_edit_store').value = row['åº—åˆ¥'] || '';
      document.getElementById('bl_edit_reason').value = row['åŸå› '] || '';
      document.getElementById('bl_edit_date').value = toDateOnly(row['æ—¥æœŸ'] || '');
      document.getElementById('bl_edit_notes').value = row['å‚™è¨»'] || '';
      blEditModal.classList.remove('hidden');
    }
    
    async function deleteBlacklistRow(idx){
      if(!confirm('åˆªé™¤é»‘åå–®?')) return;
      const fd = new FormData(); fd.append('action', 'delete'); fd.append('targetSheet','blacklist'); fd.append('row', idx);
      await fetch(SCRIPT_URL, {method:'POST', body:fd});
      fetchBlacklistData();
    }
    
    blacklistAddButton.addEventListener('click', openBlacklistAddModal);
    blacklistCloseAddModal.addEventListener('click', closeBlacklistAddModal);
    blacklistCancelAdd.addEventListener('click', closeBlacklistAddModal);
    
    blacklistAddForm.addEventListener('submit', async(e)=>{
      e.preventDefault();
      const btn = blacklistAddForm.querySelector('button[type="submit"]'); btn.disabled=true;
      try{
         const fd=new FormData(blacklistAddForm); fd.append('action','add_blacklist');
         const r = await fetch(SCRIPT_URL, {method:'POST', body:fd});
         if((await r.json()).result==='success'){ closeBlacklistAddModal(); blacklistAddForm.reset(); fetchBlacklistData(); }
      }catch(e){alert('å¤±æ•—');}finally{btn.disabled=false;}
    });
    
    blEditForm.addEventListener('submit', async(e)=>{
      e.preventDefault();
      const btn=blEditForm.querySelector('button[type="submit"]'); btn.disabled=true;
      try{
        const fd=new FormData(blEditForm); fd.append('action','update'); fd.append('targetSheet','blacklist');
        if((await (await fetch(SCRIPT_URL,{method:'POST',body:fd})).json()).result==='success'){
           blEditModal.classList.add('hidden'); fetchBlacklistData();
        }
      }catch(e){alert('å¤±æ•—');}finally{btn.disabled=false;}
    });

    // Date Buttons
    document.querySelectorAll('[data-target]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const el = document.getElementById(btn.dataset.target);
        if(el) el.value = todayLocalForInput();
      });
    });

    // Init
    window.addEventListener('load', async ()=>{
      await fetchStores();
      await fetchOrderData();
      fetchBlacklistData();
    });
    
    // Modal Listeners
    closeEditModal.addEventListener('click', closeModal);
    cancelEdit.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
    longTerm_closeEditModal.addEventListener('click', longTerm_closeModal);
    longTerm_cancelEdit.addEventListener('click', (e)=>{ e.preventDefault(); longTerm_closeModal(); });

    // Open Modal Logic
    function openEditModal(sheetRow){
      const order = allOrders.find(o => String(o['__row']) === String(sheetRow));
      if(!order) return;
      document.getElementById('editRowIndex').value = order['__row'];
      document.getElementById('editCustomerID').value = order['å®¢è™Ÿ'] || '';
      document.getElementById('editCustomerName').value = order['å§“å'] || '';
      document.getElementById('editPhone').value = formatPhone(order['é€£çµ¡é›»è©±'] || '');
      document.getElementById('editProductAName').value = order['å®¢è¨‚å•†å“A'] || '';
      document.getElementById('editProductASpec').value = order['Aå•†å“è¦æ ¼'] || '';
      document.getElementById('editProductAQty').value = order['Aæ•¸é‡'] || '';
      document.getElementById('editProductBName').value = order['å®¢è¨‚å•†å“B'] || '';
      document.getElementById('editProductBSpec').value = order['Bå•†å“è¦æ ¼'] || '';
      document.getElementById('editProductBQty').value = order['Bæ•¸é‡'] || '';
      document.getElementById('editPaid').checked = isChecked(order['ä»˜æ¸…']||order['paid']);
      document.getElementById('editPurchaseDate').value = toDateOnly(order['æ¡è³¼æ—¥æœŸ']);
      document.getElementById('editArrivalDate').value = toDateOnly(order['åˆ°è²¨æ—¥æœŸ']);
      document.getElementById('editPickupDate').value = toDateOnly(order['å–èµ°æ—¥æœŸ']);
      document.getElementById('editStoreTransfer').value = order['åˆ†åº—èª¿æ’¥'] || '';
      document.getElementById('editNotes').value = order['å‚™è¨»'] || '';
      editMissedCtrl.setItems(parseMultiDateStringToArray(order['æœªæ¥é›»è©±æ—¥æœŸ']));
      editNotifyCtrl.setItems(parseMultiDateStringToArray(order['é€šçŸ¥æ—¥æœŸ']));
      editModalBackdrop.classList.remove('hidden');
    }

    function openLongTermEditModal(sheetRow){
      const order = allLongTermOrders.find(o => String(o['__row']) === String(sheetRow));
      if(!order) return;
      document.getElementById('longTerm_editRowIndex').value = order['__row'];
      document.getElementById('longTerm_editCustomerID').value = order['å®¢è™Ÿ'] || '';
      document.getElementById('longTerm_editCustomerName').value = order['å§“å'] || '';
      document.getElementById('longTerm_editPhone').value = formatPhone(order['é€£çµ¡é›»è©±'] || '');
      document.getElementById('longTerm_editProductAName').value = order['å®¢è¨‚å•†å“A'] || '';
      document.getElementById('longTerm_editProductASpec').value = order['Aå•†å“è¦æ ¼'] || '';
      document.getElementById('longTerm_editProductAQty').value = order['Aæ•¸é‡'] || '';
      document.getElementById('longTerm_editProductBName').value = order['å®¢è¨‚å•†å“B'] || '';
      document.getElementById('longTerm_editProductBSpec').value = order['Bå•†å“è¦æ ¼'] || '';
      document.getElementById('longTerm_editProductBQty').value = order['Bæ•¸é‡'] || '';
      document.getElementById('longTerm_editPaid').checked = isChecked(order['ä»˜æ¸…']||order['paid']);
      document.getElementById('longTerm_editStoreTransfer').value = order['åˆ†åº—èª¿æ’¥'] || '';
      document.getElementById('longTerm_editNotes').value = order['å‚™è¨»'] || '';
      longTerm_editPurchaseCtrl.setItems(parseMultiDateStringToArray(order['æ¡è³¼æ—¥æœŸ']));
      longTerm_editArrivalCtrl.setItems(parseMultiDateStringToArray(order['åˆ°è²¨æ—¥æœŸ']));
      longTerm_editPickupCtrl.setItems(parseMultiDateStringToArray(order['å–èµ°æ—¥æœŸ']));
      longTerm_editMissedCtrl.setItems(parseMultiDateStringToArray(order['æœªæ¥é›»è©±æ—¥æœŸ']));
      longTerm_editNotifyCtrl.setItems(parseMultiDateStringToArray(order['é€šçŸ¥æ—¥æœŸ']));
      longTerm_editModalBackdrop.classList.remove('hidden');
    }
  </script>
</body>
</html>
